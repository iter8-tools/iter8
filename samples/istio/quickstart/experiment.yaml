apiVersion: iter8.tools/v2alpha2
kind: Experiment
metadata:
  name: istio-quickstart
spec:
  # target identifies the knative service under experimentation using its fully qualified name
  target: bookinfo-iter8/productpage
  strategy:
    # this experiment will perform a canary test
    testingPattern: Canary
    deploymentPattern: Progressive
    actions:
      finish: # run the following sequence of tasks at the end of the experiment
      - task: common/exec
        with:
          cmd: /bin/bash
          args: 
          - "-c"
          - kubectl -n {{ .namespace }} apply -f {{ .promote }}

  criteria:
    objectives: 
    - metric: iter8-istio/mean-latency
      upperLimit: 100
    - metric: iter8-istio/error-rate
      upperLimit: "0.01"
  duration:
    intervalSeconds: 10
    iterationsPerLoop: 10
  versionInfo:
    # information about app versions used in this experiment
    baseline:
      name: baseline
      variables:
      - name: revision
        value: productpage-v1
      - name: namespace
        value: bookinfo-iter8
      - name: promote
        value: https://raw.githubusercontent.com/kalantar/iter8/istio-quickstart/samples/istio/quickstart/baseline.yaml
      weightObjRef:
        apiVersion: networking.istio.io/v1beta1
        kind: VirtualService
        namespace: bookinfo-iter8
        name: bookinfo
        fieldPath: .spec.http[0].route[0].weight
    candidates:
    - name: candidate
      variables:
      - name: revision
        value: productpage-v3
      - name: namespace
        value: bookinfo-iter8
      - name: promote
        value: https://raw.githubusercontent.com/kalantar/iter8/istio-quickstart/samples/istio/quickstart/candidate.yaml
      weightObjRef:
        apiVersion: networking.istio.io/v1beta1
        kind: VirtualService
        namespace: bookinfo-iter8
        name: bookinfo
        fieldPath: .spec.http[0].route[1].weight
