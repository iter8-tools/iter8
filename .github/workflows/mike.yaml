name: Mike versioning
on:
  release:
    types: [published]

jobs:
  # Update install version
  update-install-version:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Get version
      run: |
        tarref=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
        # Strip "v" prefix from tagref
        if [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
          echo "VERSION=$(echo $tarref | sed -e 's/^v//')" >> $GITHUB_ENV
          echo "MAJOR_MINOR_VERSION=$(echo $tarref | sed -e 's/^v//' -e 's,\([0-9]*\.[0-9]*\)\.\([0-9]*\),\1,')" >> $GITHUB_ENV
        elif [[ "${{ github.ref }}" == *"master" ]]; then
          echo "VERSION=latest" >> $GITHUB_ENV
        fi
    - uses: actions/setup-python@v2
      with:
        python-version: '3.x'
    - name: Create new version
      run: |
        git config --global user.name "Alan Cha"
        git config --global user.email ac3805@columbia.edu 
        cd mkdocs
        pip install --upgrade pip
        pip install -r requirements.txt
        mike deploy ${{ env.MAJOR_MINOR_VERSION }} latest -p -u