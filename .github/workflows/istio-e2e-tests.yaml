name: e2e tests

on:
  push:
    branches:
    - master
    paths:
    - 'install/**'
    - 'samples/istio/**'
    - '.github/workflows/istio-e2e-tests.yaml'
  pull_request:
    paths:
    - 'install/**'
    - 'samples/istio/**'
    - '.github/workflows/istio-e2e-tests.yaml'

jobs:
  quickstart:
    name: quickstart experiment
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    
    - uses: engineerd/setup-kind@v0.5.0
    - name: platform setup
      run: |
        export ITER8=$(pwd)
        export GIT_ACCOUNT=kalantar
        export TAG=istio-stack
        $ITER8/samples/istio/quickstart/platformsetup.sh contour

    - name: create bookinfo namespace, application, and microservice versions; readiness check
      run: |
        export ITER8=$(pwd)
        kubectl apply -f $ITER8/samples/istio/quickstart/namespace.yaml
        kubectl apply -n bookinfo-iter8 -f $ITER8/samples/istio/quickstart/bookinfo-app.yaml
        kubectl apply -n bookinfo-iter8 -f $ITER8/samples/istio/quickstart/productpage-v3.yaml
        kubectl apply -n bookinfo-iter8 -f $ITER8/samples/istio/quickstart/bookinfo-gateway.yaml
        kubectl -n bookinfo-iter8 wait --for=condition=Ready pods --all --timeout=240s

    - name: create Fortio job and create experiment
      run: |
        export ITER8=$(pwd)
        URL_VALUE="http://$(kubectl -n istio-system get svc istio-ingressgateway -o jsonpath='{.spec.clusterIP}'):80/productpage"
        sed "s+URL_VALUE+${URL_VALUE}+g" $ITER8/samples/istio/quickstart/fortio.yaml | kubectl apply -f -
        
        # Wait for Fortio to be ready
        pod_name=$(kubectl get pods --selector=job-name=fortio -o jsonpath='{.items[*].metadata.name}')
        kubectl wait --for=condition=Ready pods/"$pod_name" --timeout=240s

        # Starting the experiment
        kubectl apply -f $ITER8/samples/istio/quickstart/experiment.yaml

    - name: Sleep until end of experiment
      run: |
        sleep 150.0
        kubectl get experiment istio-quickstart -o yaml
    
    - name: Check if experiment is complete and successful
      run: |
        export ITER8=$(pwd)
        source $ITER8/samples/istio/quickstart/check.sh
