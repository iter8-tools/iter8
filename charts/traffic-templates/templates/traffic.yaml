{{- $versions := include "resolve.modelVersions" . | mustFromJson }}

{{- /* validate values for templateName */}}
{{- if not (has .Values.templateName (list "initialize-rollout" "modify-weights")) }}
  {{- printf "Unknown templateName: '%s'" .Values.templateName | fail }}
{{- end}}

{{- /* validate values for targetEnv */}}
{{- if not (has .Values.targetEnv (list "kserve-modelmesh" "kserve")) }}
  {{- printf "Unknown targetEnv: '%s'" .Values.targetEnv | fail }}
{{- end}}

{{- /* validate values for trafficStrategy */}}
{{- if not (has .Values.trafficStrategy (list "blue-green" "canary")) }}
  {{- printf "Unknown trafficStrategy: '%s'" .Values.trafficStrategy | fail }}
{{- end}}

{{- /* handle initialize-rollout */}}
{{- if eq "initialize-rollout" .Values.templateName }}

  {{- /* gateway needed only for kserve-modelmesh */}}
  {{- if eq "kserve-modelmesh" .Values.targetEnv }}
    {{ include "initial.gateway" . }}
  {{- end }}
---
  {{- if eq "kserve-modelmesh" .Values.targetEnv }}
    {{ include "initial.virtualservice" . }}
  {{- else }} {{- /* eq "kserve" .Values.targetEnv */}}
    {{- if eq "blue-green" .Values.trafficStrategy }}
      {{ include "initial.virtualservice-kserve-bg" . }}
    {{- else }} {{- /* eq "canary" .Values.trafficStrategy */}}
      {{ include "initial.virtualservice-kserve-canary" . }}
    {{- end }}
  {{- end }}
---
  {{- if eq "kserve-modelmesh" .Values.targetEnv }}
    {{ include "initial.serviceentry" . }}
  {{- else }} {{- /* eq "kserve" .Values.targetEnv */}}
    {{ include "initial.service-kserve" . }}
  {{- end }}
---
  {{- if eq "kserve-modelmesh" .Values.targetEnv }}
    {{- if eq "blue-green" .Values.trafficStrategy }}
      {{ include "routemap-bluegreen" . }}
    {{- else {{- /* eq "canary" .Values.trafficStrategy */}}
      {{ include "routemap-canary" . }}
    {{- end }}
  {{- else }} {{- /* eq "kserve" .Values.targetEnv */}}
    {{- if eq "blue-green" .Values.trafficStrategy }}
      {{ include "routemap-bluegreen-kserve" . }}
    {{- else }} {{- /* eq "canary" .Values.trafficStrategy */}}
      {{ include "routemap-canary-kserve" . }}
    {{- end }}
  {{- end }}
---
  {{- if eq "blue-green" .Values.trafficStrategy }}
    {{- range $i, $v := $versions }}
      {{ include "create.weight-config" (unset $v "weight") }}
---
    {{- end }}
  {{- else if eq "mirror" .Values.trafficStrategy }}
    {{- range $i, $v := (rest $versions) }}
      {{ include "create.weight-config" (unset $v "weight") }}
---
    {{- end }}
  {{- end }}

{{- else if eq "modify-weights" .Values.templateName }}
  {{- if eq "blue-green" .Values.trafficStrategy }}
    {{- range $i, $v := .Values.modelVersions }}
      {{ include "create.weight-config" $v }}
---
    {{- end }}
  {{- else if eq "mirror" .Values.trafficStrategy }}
    {{- range $i, $v := (rest $versions) }}
      {{ include "create.weight-config" (set $v "weight" $.Values.mirrorPercentage) }}
---
    {{- end }}
  {{- end }}

{{- end }}
