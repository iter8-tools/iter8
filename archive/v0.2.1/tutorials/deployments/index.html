<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.74.3"><meta name=description content="Robust analytics and control to unleash cloud-native continuous experimentation."><meta name=author content="Alan Cha"><link rel=icon href=/hugo-iter8-docs/archive/v0.2.1/images/favicon.png type=image/png><title>Automated canary releases with iter8 on Kubernetes and Istio :: iter8 Documentation</title><link href=/hugo-iter8-docs/archive/v0.2.1/css/nucleus.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/fontawesome-all.min.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/hybrid.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/featherlight.min.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/perfect-scrollbar.min.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/auto-complete.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/atom-one-dark-reasonable.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/theme.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/hugo-theme.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/theme-mine.css?1596187881 rel=stylesheet><script src=/hugo-iter8-docs/archive/v0.2.1/js/jquery-3.3.1.min.js?1596187881></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style></head><body data-url=/hugo-iter8-docs/archive/v0.2.1/tutorials/deployments/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=https://iter8.tools/archive/v0.2.1><img src=/hugo-iter8-docs/archive/v0.2.1/images/logo.png></a></div><a href=/hugo-iter8-docs/archive/v0.2.1/releases/>v0.2.1</a><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/hugo-iter8-docs/archive/v0.2.1/js/lunr.min.js?1596187881></script><script type=text/javascript src=/hugo-iter8-docs/archive/v0.2.1/js/auto-complete.js?1596187881></script><script type=text/javascript>var baseurl="https:\/\/alan-cha.github.io\/hugo-iter8-docs\/archive\/v0.2.1";</script><script type=text/javascript src=/hugo-iter8-docs/archive/v0.2.1/js/search.js?1596187881></script></div><div class=highlightable><ul class=topics><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/introduction/ title=Introduction class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/introduction/>Introduction</a><ul><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/introduction/about/ title="Iter8 enables statistically robust continuous experimentation of microservices in your CI/CD pipelines" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/introduction/about/>About</a></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/ title=Installation class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/>Installation</a><ul><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/kubernetes/ title="Iter8 on Kubernetes and Istio" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/kubernetes/>Kubernetes</a></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/red-hat/ title="Iter8 on Red Hat OpenShift" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/red-hat/>Red Hat OpenShift</a></li></ul></li></ul></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/reference/ title=Reference class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/reference/>Reference</a><ul><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/reference/metrics/ title="Iter8's metrics" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/reference/metrics/>Metrics</a></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/reference/experiment/ title="Iter8's experiment CRD" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/reference/experiment/>Experiment</a></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/reference/algorithms/ title="Iter8's algorithms" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/reference/algorithms/>Algorithms</a></li></ul></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/tutorials/ title=Tutorials class="dd-item
parent"><a href=/hugo-iter8-docs/archive/v0.2.1/tutorials/>Tutorials</a><ul><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/tutorials/deployments/ title="Automated canary releases with iter8 on Kubernetes and Istio" class="dd-item active"><a href=/hugo-iter8-docs/archive/v0.2.1/tutorials/deployments/>Deployments</a></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/tutorials/services/ title="Automated Canary Rollout Using Services" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/tutorials/services/>Services</a></li></ul></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/releases/ title="Older releases" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/releases/>Older releases</a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/iter8-tools/iter8><i class="fab fa-fw fa-github"></i>GitHub repo</a></li><li><a class=padding href=https://join.slack.com/t/iter8-tools/shared_invite/enQtODU0NTczMTQ5NDU4LTJmNGE1OTBhOWI4NzllZGE0ZjdhM2M3MzJlMjcxYjliMTJlM2YxMzQ4OWQ5NGViYTM2MTU4MWRkZTgxNzZiMzg><i class="fab fa-fw fa-slack"></i>Slack workspace</a></li></ul></section><section id=footer></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/iter8-tools/docs/edit/master/content/tutorials/deployments.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/hugo-iter8-docs/archive/v0.2.1/>Homepage</a> > <a href=/hugo-iter8-docs/archive/v0.2.1/tutorials/>Tutorials</a> > Automated canary releases with iter8 on Kubernetes and Istio</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#yaml-files-used-in-the-tutorial>YAML files used in the tutorial</a></li><li><a href=#part-1-successful-canary-release-_reviews-v2_-to-_reviews-v3_>Part 1: Successful canary release: <em>reviews-v2</em> to <em>reviews-v3</em></a><ul><li><a href=#1-deploy-the-bookinfo-application>1. Deploy the Bookinfo application</a></li><li><a href=#2-access-the-bookinfo-application>2. Access the Bookinfo application</a></li><li><a href=#3-generate-load-to-the-application>3. Generate load to the application</a></li><li><a href=#4-configure-a-canary-rollout-for-the-_reviews_-service>4. Configure a canary rollout for the <em>reviews</em> service</a></li><li><a href=#5-deploy-the-canary-version-and-start-the-rollout>5. Deploy the canary version and start the rollout</a></li><li><a href=#6-check-the-grafana-dashboard>6. Check the Grafana dashboard</a></li></ul></li><li><a href=#part-2-high-latency-canary-release-_reviews-v3_-to-_reviews-v4_>Part 2: High-latency canary release: <em>reviews-v3</em> to <em>reviews-v4</em></a><ul><li><a href=#1-canary-rollout-configuration>1. Canary rollout configuration</a></li><li><a href=#2-deploy-_reviews-v4_-and-start-the-rollout>2. Deploy <em>reviews-v4</em> and start the rollout</a></li><li><a href=#3-check-the-grafana-dashboard>3. Check the Grafana dashboard</a></li></ul></li><li><a href=#part-3-error-producing-canary-release-_reviews-v3_-to-_reviews-v5_>Part 3: Error-producing canary release: <em>reviews-v3</em> to <em>reviews-v5</em></a><ul><li><a href=#1-canary-rollout-configuration-1>1. Canary rollout configuration</a></li><li><a href=#2-deploy-_reviews-v5_-and-start-the-rollout>2. Deploy <em>reviews-v5</em> and start the rollout</a></li><li><a href=#3-check-the-grafana-dashboard-1>3. Check the Grafana dashboard</a></li></ul></li><li><a href=#part-4-using-a-custom-metric>Part 4: Using a custom metric</a><ul><li></li><li><a href=#1-canary-rollout-configuration-2>1. Canary rollout configuration</a></li><li><a href=#2-deploy-_reviews-v6_-and-start-the-rollout>2. Deploy <em>reviews-v6</em> and start the rollout</a></li><li><a href=#3-check-the-grafana-dashboard-2>3. Check the Grafana dashboard</a></li></ul></li><li><a href=#part-5-user-facing-canary-release-_productpage-v1_-to-_productpage-v2_>Part 5: User-facing Canary release: <em>productpage-v1</em> to <em>productpage-v2</em></a><ul><li><a href=#1-traffic-configuration>1. Traffic configuration</a></li><li><a href=#2-canary-rollout-configuration>2. Canary rollout configuration</a></li><li><a href=#3-deploy-_productpage-v2_-and-start-the-rollout>3. Deploy <em>productpage-v2</em> and start the rollout</a></li></ul></li><li><a href=#cleanup>Cleanup</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Automated canary releases with iter8 on Kubernetes and Istio</h1><p>This tutorial shows you how <em>iter8</em> can be used to perform canary releases by gradually shifting traffic to a canary version of a microservice.</p><p>This tutorial has 5 parts, which are supposed to be tried in order. <strong>Here you will learn:</strong></p><ul><li>how to perform a canary rollout with <em>iter8</em>;</li><li>how to set different success criteria for <em>iter8</em> to analyze canary releases and determine success or failure;</li><li>how to have <em>iter8</em> immediately stop an experiment as soon as a criterion is not met;</li><li>how to use your own custom metrics in success criteria for canary analyses; and</li><li>how <em>iter8</em> can be used for canary releases of both internal and user-facing services.</li></ul><p>The tutorial is based on the <a href=https://istio.io/docs/examples/bookinfo/>Bookinfo sample application</a> that is distributed with Istio. This application comprises 4 microservices, namely, <em>productpage</em>, <em>details</em>, <em>reviews</em>, and <em>ratings</em>, as illustrated <a href=https://istio.io/docs/examples/bookinfo/>here</a>. Please, follow our instructions below to deploy the sample application as part of the tutorial.</p><h2 id=yaml-files-used-in-the-tutorial>YAML files used in the tutorial</h2><p>All Kubernetes YAML files you will need in this tutorial are in the <em>iter8-controller</em> repository <a href=https://github.com/iter8-tools/iter8-controller/tree/v0.2.1/doc/tutorials/istio/bookinfo>here</a>.</p><h2 id=part-1-successful-canary-release-_reviews-v2_-to-_reviews-v3_>Part 1: Successful canary release: <em>reviews-v2</em> to <em>reviews-v3</em></h2><h3 id=1-deploy-the-bookinfo-application>1. Deploy the Bookinfo application</h3><p>At this point, we assume that you have already followed the <a href=iter8_install.md>instructions</a> to install <em>iter8</em> on your Kubernetes cluster. The next step is to deploy the sample application we will use for the tutorial.</p><p>First, let us create a <code>bookinfo-iter8</code> namespace configured to enable auto-injection of the Istio sidecar:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/namespace.yaml
</code></pre></div><p>Next, let us deploy the Bookinfo application:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/bookinfo-tutorial.yaml
</code></pre></div><p>You should see the following pods in the <code>bookinfo-iter8</code> namespace. Make sure the pods&rsquo; status is &ldquo;Running.&rdquo; Also, note that there should be 2 containers in each pod, since the Istio sidecar was injected.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get pods -n bookinfo-iter8
NAME                              READY   STATUS    RESTARTS   AGE
details-v1-68c7c8666d-m78qx       2/2     Running   <span style=color:#ae81ff>0</span>          64s
productpage-v1-7979869ff9-fln6g   2/2     Running   <span style=color:#ae81ff>0</span>          63s
ratings-v1-8558d4458d-rwthl       2/2     Running   <span style=color:#ae81ff>0</span>          64s
reviews-v2-df64b6df9-ffb42        2/2     Running   <span style=color:#ae81ff>0</span>          63s
</code></pre></div><p>We have deployed &ldquo;version 2&rdquo; of the <em>reviews</em> microservice, and version 1 of all others.</p><p>Let us now expose the edge <em>productpage</em> service by creating an Istio Gateway for it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/bookinfo-gateway.yaml
</code></pre></div><p>You should now see the Istio Gateway and VirtualService for <em>productpage</em>, as below:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get gateway -n bookinfo-iter8
NAME               AGE
bookinfo-gateway   22s
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get vs -n bookinfo-iter8
NAME       GATEWAYS             HOSTS                   AGE
bookinfo   <span style=color:#f92672>[</span>bookinfo-gateway<span style=color:#f92672>]</span>   <span style=color:#f92672>[</span>bookinfo.sample.dev<span style=color:#f92672>]</span>   27s
</code></pre></div><p>As you can see above, we have associated Bookinfo&rsquo;s edge service with a fake host, namely, <code>bookinfo.sample.dev</code>.</p><h3 id=2-access-the-bookinfo-application>2. Access the Bookinfo application</h3><p>To access the application, you need to determine the ingress IP and port for the application in your environment. You can do so by following steps 3 and 4 of the Istio instructions <a href=https://istio.io/docs/examples/bookinfo/#determine-the-ingress-ip-and-port>here</a> to set the environment variables <code>INGRESS_HOST</code>, <code>INGRESS_PORT</code>, and <code>GATEWAY_URL</code>, which will capture the correct IP address and port for your environment. Once you have done so, you can check if you can access the application with the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -H <span style=color:#e6db74>&#34;Host: bookinfo.sample.dev&#34;</span> -o /dev/null -s -w <span style=color:#e6db74>&#34;%{http_code}\n&#34;</span> <span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>${</span>GATEWAY_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/productpage&#34;</span>
</code></pre></div><p>If everything is working, the command above should show <code>200</code>. Note that the curl command above sets the host header to match the host we associated the VirtualService with (<code>bookinfo.sample.dev</code>). If you want to access the application from your browser, you will need to set this header using a browser&rsquo;s plugin of your choice.</p><h3 id=3-generate-load-to-the-application>3. Generate load to the application</h3><p>Let us now generate load to the application, emulating requests coming from users. To do so, we recommend you run the command below on a separate terminal:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>watch -n 0.1 <span style=color:#e6db74>&#39;curl -H &#34;Host: bookinfo.sample.dev&#34; -Is &#34;http://${GATEWAY_URL}/productpage&#34;&#39;</span>
</code></pre></div><p>This command will send 10 requests per second to the application. Note that the environment variable <code>GATEWAY_URL</code> must have been set as per step 2 above. Among other things, the command output should show an HTTP code of 200, as below:</p><pre><code>HTTP/1.1 200 OK
content-type: text/html; charset=utf-8
content-length: 5719
server: istio-envoy
(...)
</code></pre><h3 id=4-configure-a-canary-rollout-for-the-_reviews_-service>4. Configure a canary rollout for the <em>reviews</em> service</h3><p>At this point, Bookinfo is using version 2 of the <em>reviews</em> service (<em>reviews-v2</em>). Let us now use <em>iter8</em> to automate the canary rollout of version 3 of this service (<em>reviews-v3</em>).</p><p>First, we need to tell <em>iter8</em> that we are about to perform this canary rollout. To that end, we create an <code>Experiment</code> configuration specifying the rollout details. In this tutorial, let us use the following <code>Experiment</code> configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: iter8.tools/v1alpha1
<span style=color:#66d9ef>kind</span>: Experiment
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: reviews-v3-rollout
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>targetService</span>:
    <span style=color:#66d9ef>name</span>: reviews
    <span style=color:#66d9ef>apiVersion</span>: v1
    <span style=color:#66d9ef>baseline</span>: reviews-v2
    <span style=color:#66d9ef>candidate</span>: reviews-v3
  <span style=color:#66d9ef>trafficControl</span>:
    <span style=color:#66d9ef>strategy</span>: check_and_increment
    <span style=color:#66d9ef>interval</span>: 30s
    <span style=color:#66d9ef>trafficStepSize</span>: <span style=color:#ae81ff>20</span>
    <span style=color:#66d9ef>maxIterations</span>: <span style=color:#ae81ff>8</span>
    <span style=color:#66d9ef>maxTrafficPercentage</span>: <span style=color:#ae81ff>80</span>
  <span style=color:#66d9ef>analysis</span>:
    <span style=color:#66d9ef>analyticsService</span>: <span style=color:#e6db74>&#34;http://iter8-analytics:8080&#34;</span>
    <span style=color:#66d9ef>successCriteria</span>:
      - <span style=color:#66d9ef>metricName</span>: iter8_latency
        <span style=color:#66d9ef>toleranceType</span>: threshold
        <span style=color:#66d9ef>tolerance</span>: <span style=color:#ae81ff>200</span>
        <span style=color:#66d9ef>sampleSize</span>: <span style=color:#ae81ff>5</span>
</code></pre></div><p>The configuration above specifies the baseline and candidate versions in terms of Kubernetes deployment names. The rollout is configured to last for 8 iterations (<code>maxIterations</code>) of <code>30s</code> (<code>interval</code>). At the end of each iteration, if the candidate version meets the specified success criteria, the traffic sent to it will increase by 20 percentage points (<code>trafficStepSize</code>) up to 80% (<code>maxTrafficPercentage</code>). At the end of the last iteration, if the success criteria are met, the candidate version will take over from the baseline.</p><p>In the example above, we specified only one success criterion. In particular, we stated that the mean latency exhibited by the candidate version should not exceed the threshold of 200 milliseconds. At the end of each iteration, <em>iter8-controller</em> calls <em>iter8-analytics</em>, which in turn analyzes the metrics of interest (in this case, only mean latency) against the corresponding criteria. The number of data points analyzed during an experiment is cumulative, that is, it carries over from iteration to iteration.</p><p>The next step of this tutorial is to actually create the configuration above. To that end, you can either copy and paste the yaml above to a file and then run <code>kubectl apply -n bookinfo-iter8 -f</code> on it, or you can run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/canary_reviews-v2_to_reviews-v3.yaml
</code></pre></div><p>You can verify that the <code>Experiment</code> object has been created as shown below:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE   STATUS                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Pause   TargetsNotFound: Missing Candidate   reviews-v2   <span style=color:#ae81ff>100</span>          reviews-v3   <span style=color:#ae81ff>0</span>
</code></pre></div><p>As you can see, <em>iter8</em> is reporting that 100% of the traffic is sent to the baseline version (<em>reviews-v2</em>) and that the candidate (<em>reviews-v3</em>) is missing. As soon as the controller sees the candidate version, it will start the rollout. Next, let us deploy the candidate version to trigger the canary rollout.</p><h3 id=5-deploy-the-canary-version-and-start-the-rollout>5. Deploy the canary version and start the rollout</h3><p>As soon as we deploy <em>reviews-v3</em>, <em>iter8-controller</em> will start the rollout. To deploy <em>reviews-v3</em>, you can run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/reviews-v3.yaml
</code></pre></div><p>Now, if you check the state of the <code>Experiment</code> object corresponding to this rollout, you should see that the rollout is in progress, and that 20% of the traffic is now being sent to <em>reviews-v3</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE         STATUS                                 BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Progressing   IterationUpdate: Iteration <span style=color:#ae81ff>1</span> Started   reviews-v2   <span style=color:#ae81ff>80</span>           reviews-v3   <span style=color:#ae81ff>20</span>
</code></pre></div><p>At about every 30s you should see the traffic shift towards <em>reviews-v3</em> by 20 percentage points.</p><h3 id=6-check-the-grafana-dashboard>6. Check the Grafana dashboard</h3><p>You can also check a Grafana dashboard specific to the <code>Experiment</code> object corresponding to the rollout you are running. The URL to the Grafana dashboard for the experiment is the value of the field <code>grafanaURL</code> under the object&rsquo;s <code>status</code>. One way to get the Grafana URL that you can paste to your browser is through the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get experiment reviews-v3-rollout -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.status.grafanaURL}&#39;</span> -n bookinfo-iter8
</code></pre></div><p>By default, the base URL given by iter8 to Grafana is <code>http://localhost:3000</code>. In a typical Istio installation, you can port-forward your Grafana from Kubernetes to your localhost&rsquo;s port 3000 with the following command:</p><pre><code>kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=grafana -o jsonpath='{.items[0].metadata.name}') 3000:3000
</code></pre><p>Below is a screenshot of a portion of the Grafana dashboard showing the request rate and the mean latency for reviews-v2 and reviews-v3, right after the controller ended the experiment.</p><p><img src=/images/grafana_reviews-v2-v3.png alt="Grafana Dashboard"></p><p>Note how the traffic shifted towards the canary during the experiment. You can also see that the canary&rsquo;s mean latency was way below the configured threshold of 200 milliseconds.</p><h2 id=part-2-high-latency-canary-release-_reviews-v3_-to-_reviews-v4_>Part 2: High-latency canary release: <em>reviews-v3</em> to <em>reviews-v4</em></h2><p>At this point, you must have completed the part 1 of the tutorial successfully. You can confirm it as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiment reviews-v3-rollout -n bookinfo-iter8
NAME                 PHASE         STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed     ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   <span style=color:#ae81ff>0</span>            reviews-v3   <span style=color:#ae81ff>100</span>
</code></pre></div><p>The command above&rsquo;s output shows that <em>reviews-v3</em> took over from <em>reviews-v2</em> as part of the canary rollout performed before.</p><h3 id=1-canary-rollout-configuration>1. Canary rollout configuration</h3><p>Now, let us set up a canary rollout for <em>reviews-v4</em>, using the following <code>Experiment</code> configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: iter8.tools/v1alpha1
<span style=color:#66d9ef>kind</span>: Experiment
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: reviews-v4-rollout
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>targetService</span>:
    <span style=color:#66d9ef>name</span>: reviews
    <span style=color:#66d9ef>apiVersion</span>: v1
    <span style=color:#66d9ef>baseline</span>: reviews-v3
    <span style=color:#66d9ef>candidate</span>: reviews-v4
  <span style=color:#66d9ef>trafficControl</span>:
    <span style=color:#66d9ef>strategy</span>: check_and_increment
    <span style=color:#66d9ef>interval</span>: 30s
    <span style=color:#66d9ef>trafficStepSize</span>: <span style=color:#ae81ff>20</span>
    <span style=color:#66d9ef>maxIterations</span>: <span style=color:#ae81ff>6</span>
    <span style=color:#66d9ef>maxTrafficPercentage</span>: <span style=color:#ae81ff>80</span>
  <span style=color:#66d9ef>analysis</span>:
    <span style=color:#66d9ef>analyticsService</span>: <span style=color:#e6db74>&#34;http://iter8-analytics:8080&#34;</span>
    <span style=color:#66d9ef>successCriteria</span>:
      - <span style=color:#66d9ef>metricName</span>: iter8_latency
        <span style=color:#66d9ef>toleranceType</span>: threshold
        <span style=color:#66d9ef>tolerance</span>: <span style=color:#ae81ff>200</span>
        <span style=color:#66d9ef>sampleSize</span>: <span style=color:#ae81ff>5</span>
</code></pre></div><p>The configuration above is pretty much the same we used in part 1, except that now the baseline version is <em>reviews-v3</em> and the candidate is <em>reviews-v4</em>.</p><p>To create the above <code>Experiment</code> object, run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/canary_reviews-v3_to_reviews-v4.yaml
</code></pre></div><p>You can list all <code>Experiment</code> objects like so:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   <span style=color:#ae81ff>0</span>            reviews-v3   <span style=color:#ae81ff>100</span>
reviews-v4-rollout   Pause       TargetsNotFound: Missing Candidate                   reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v4   <span style=color:#ae81ff>0</span>
</code></pre></div><p>The output above shows the new object you just created, for which the candidate deployment <em>reviews-v4</em> is missing. Let us deploy <em>reviews-v4</em> next so that the rollout can begin.</p><h3 id=2-deploy-_reviews-v4_-and-start-the-rollout>2. Deploy <em>reviews-v4</em> and start the rollout</h3><p>As you have already seen, as soon as we deploy the candidate version, <em>iter8-controller</em> will start the rollout. This time, however, the candidate version (<em>reviews-v4</em>) has a performance issue preventing it from satisfying the success criteria in the experiment object. As a result, <em>iter8</em> will roll back to the baseline version.</p><p>To deploy <em>reviews-v4</em>, run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/reviews-v4.yaml
</code></pre></div><p>Now, if you check the state of the <code>Experiment</code> object corresponding to this rollout, you should see that the rollout is in progress, and that 20% of the traffic is now being sent to <em>reviews-v4</em>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE         STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed     ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   <span style=color:#ae81ff>0</span>            reviews-v3   <span style=color:#ae81ff>100</span>
reviews-v4-rollout   Progressing   IterationUpdate: Iteration <span style=color:#ae81ff>1</span> Started                 reviews-v3   <span style=color:#ae81ff>80</span>           reviews-v4   <span style=color:#ae81ff>20</span>
</code></pre></div><p>However, unlike the previous rollout, traffic will not shift towards the candidate <em>reviews-v4</em> because it does not meet the success criteria due to a performance problem. At the end of the experiment, <em>iter8</em> rolls back to the baseline (<em>reviews-v3</em>), as seen below:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiment reviews-v4-rollout -n bookinfo-iter8
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v4   <span style=color:#ae81ff>0</span>
</code></pre></div><h3 id=3-check-the-grafana-dashboard>3. Check the Grafana dashboard</h3><p>As before, you can check the Grafana dashboard corresponding to the canary release of <em>reviews-v4</em>. To get the URL to the dashboard specific to this canary release, run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get experiment reviews-v4-rollout -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.status.grafanaURL}&#39;</span> -n bookinfo-iter8
</code></pre></div><p><img src=/images/grafana_reviews-v3-v4.png alt="Grafana Dashboard"></p><p>The dashboard screenshot above shows that the canary version (<em>reviews-v4</em>) consistently exhibits a high latency of 5 seconds, way above the threshold of 200 milliseconds specified in our success criterion, and way above the baseline version&rsquo;s latency.</p><h2 id=part-3-error-producing-canary-release-_reviews-v3_-to-_reviews-v5_>Part 3: Error-producing canary release: <em>reviews-v3</em> to <em>reviews-v5</em></h2><p>At this point, you must have completed parts 1 and 2 of the tutorial successfully. You can confirm it as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   <span style=color:#ae81ff>0</span>            reviews-v3   <span style=color:#ae81ff>100</span>
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v4   <span style=color:#ae81ff>0</span>
</code></pre></div><p>The command above&rsquo;s output shows that <em>reviews-v3</em> took over from <em>reviews-v2</em> as part of the canary rollout performed before on part 1, and that it continues to be the current version after iter8 had determined that <em>reviews-v4</em> was unsatisfactory.</p><h3 id=1-canary-rollout-configuration-1>1. Canary rollout configuration</h3><p>Now, let us set up a canary rollout for <em>reviews-v5</em>, using the following <code>Experiment</code> configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: iter8.tools/v1alpha1
<span style=color:#66d9ef>kind</span>: Experiment
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: reviews-v5-rollout
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>targetService</span>:
    <span style=color:#66d9ef>name</span>: reviews
    <span style=color:#66d9ef>apiVersion</span>: v1
    <span style=color:#66d9ef>baseline</span>: reviews-v3
    <span style=color:#66d9ef>candidate</span>: reviews-v5
  <span style=color:#66d9ef>trafficControl</span>:
    <span style=color:#66d9ef>strategy</span>: check_and_increment
    <span style=color:#66d9ef>interval</span>: 30s
    <span style=color:#66d9ef>trafficStepSize</span>: <span style=color:#ae81ff>20</span>
    <span style=color:#66d9ef>maxIterations</span>: <span style=color:#ae81ff>6</span>
    <span style=color:#66d9ef>maxTrafficPercentage</span>: <span style=color:#ae81ff>80</span>
  <span style=color:#66d9ef>analysis</span>:
    <span style=color:#66d9ef>analyticsService</span>: <span style=color:#e6db74>&#34;http://iter8-analytics:8080&#34;</span>
    <span style=color:#66d9ef>successCriteria</span>:
      - <span style=color:#66d9ef>metricName</span>: iter8_latency
        <span style=color:#66d9ef>toleranceType</span>: threshold
        <span style=color:#66d9ef>tolerance</span>: <span style=color:#ae81ff>200</span>
        <span style=color:#66d9ef>sampleSize</span>: <span style=color:#ae81ff>5</span>
      - <span style=color:#66d9ef>metricName</span>: iter8_error_rate
        <span style=color:#66d9ef>toleranceType</span>: delta
        <span style=color:#66d9ef>tolerance</span>: <span style=color:#ae81ff>0.02</span>
        <span style=color:#66d9ef>sampleSize</span>: <span style=color:#ae81ff>10</span>
        <span style=color:#66d9ef>stopOnFailure</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>The configuration above differs from the previous ones as follows. We added a second success criterion on the error-rate metric so that the canary version (<em>reviews-v5</em>) not only must have a mean latency below 200 milliseconds, but it also needs to have an error rate that cannot exceed the baseline error rate by more than 2%. That comparative analysis on a metric is specified as a <code>delta</code> tolerance type. Furthermore, the second success criterion sets the flag <code>stopOnFailure</code>, which means iter8 will roll back to the baseline as soon as the error rate criterion is violated and the minimum number of 10 data points is collected (<code>sampleSize = 10</code>).</p><p>To create the above <code>Experiment</code> object, run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/canary_reviews-v3_to_reviews-v5.yaml
</code></pre></div><h3 id=2-deploy-_reviews-v5_-and-start-the-rollout>2. Deploy <em>reviews-v5</em> and start the rollout</h3><p>As you already know, as soon as we deploy the candidate version, <em>iter8-controller</em> will start the rollout. This time, the candidate version (<em>reviews-v5</em>) has a bug that causes it to return HTTP errors to its callers. As a result, <em>iter8</em> will roll back to the baseline version based on the success criterion on the error-rate metric defined above.</p><p>To deploy <em>reviews-v5</em>, run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/reviews-v5.yaml
</code></pre></div><p>If you check the state of the <code>Experiment</code> object corresponding to this rollout, you should see that the rollout is in progress, and that 20% of the traffic is now being sent to <em>reviews-v5</em>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE         STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed     ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   <span style=color:#ae81ff>0</span>            reviews-v3   <span style=color:#ae81ff>100</span>
reviews-v4-rollout   Completed     ExperimentFailed: Not All Success Criteria Met       reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v4   <span style=color:#ae81ff>0</span>
reviews-v5-rollout   Progressing   IterationUpdate: Iteration <span style=color:#ae81ff>1</span> Started                 reviews-v3   <span style=color:#ae81ff>80</span>           reviews-v5   <span style=color:#ae81ff>20</span>
</code></pre></div><p>Because <em>review-v5</em> has an issue causing it to return HTTP errors, as per the success criteria we have specified the traffic will not shift towards it. Furthermore, because the error-rate success criteria indicated the need to stop on failure, without waiting for the entire duration of the experiment, iter8 will rollback to <em>reviews-v3</em> quickly. You should see the following after several seconds:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   <span style=color:#ae81ff>0</span>            reviews-v3   <span style=color:#ae81ff>100</span>
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v4   <span style=color:#ae81ff>0</span>
reviews-v5-rollout   Completed   ExperimentFailed: Aborted                            reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v5   <span style=color:#ae81ff>0</span>
</code></pre></div><h3 id=3-check-the-grafana-dashboard-1>3. Check the Grafana dashboard</h3><p>As before, you can check the Grafana dashboard corresponding to the canary release of <em>reviews-v5</em>. To get the URL to the dashboard specific to this canary release, run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get experiment reviews-v5-rollout -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.status.grafanaURL}&#39;</span> -n bookinfo-iter8
</code></pre></div><p><img src=/images/grafana_reviews-v3-v5-req-rate.png alt="Grafana Dashboard">
<img src=/images/grafana_reviews-v3-v5-error-rate.png alt="Grafana Dashboard"></p><p>The dashboard screenshots above show that traffic to the canary version (<em>reviews-v5</em>) is quickly interrupted. Also, while the <em>reviews-v5</em> latency is way below the threshold of 200 milliseconds we defined in the latency success criterion, its error rate is 100%, i.e., it generates errors for every single request it processes. That does not meet the error-rate success criterion we defined, which specified that the canary&rsquo;s error rate must be within 2% of that of the baseline (<em>reviews-v3</em>) version. According to the dashboard, <em>reviews-v3</em> produced no errors at all.</p><h2 id=part-4-using-a-custom-metric>Part 4: Using a custom metric</h2><p>At this point, you should have completed parts 1, 2, and 3 of the tutorial successfully. You can confirm it as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   <span style=color:#ae81ff>0</span>            reviews-v3   <span style=color:#ae81ff>100</span>
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v4   <span style=color:#ae81ff>0</span>
reviews-v5-rollout   Completed   ExperimentFailed: Aborted                            reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v5   <span style=color:#ae81ff>0</span>
</code></pre></div><p>The command above&rsquo;s output shows that <em>reviews-v3</em> took over from <em>reviews-v2</em> as part of the canary rollout performed before in part 1, and that it continued to be the current version of the <em>reviews</em> service after iter8 had determined that <em>reviews-v4</em> was unsatisfactory. Similarly, as we saw in the previous part 3, the experiment to rollout <em>reviews-v5</em> was aborted because of failure to satisfy the success criteria defined by the user.</p><p>In this tutorial, we will define a custom metric (one not provided by <em>iter8</em> out of the box) and use it in the success criteria for a canary release.</p><p>By default <em>iter8</em> provides a few metrics which you can see if you type:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get configmap iter8config-metrics -n iter8 -oyaml
</code></pre></div><p>In principle, any metric that can be derived from the data you have in your Prometheus database that might be meaningful to you in assessing the health of a service version can be used by <em>iter8</em>. Next, we are going to make <em>iter8</em> aware of a metric that we will call <em>iter8_90_perc_latency</em>, which measures the 90th percentile latency of a service. In order to make <em>iter8</em> aware of a new metric we need to add it to the <em>iter8config-metrics</em> config map. For the purposes of this tutorial, we will do so by running the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/iter8_metrics_extended.yaml
</code></pre></div><p>Or, if using a newer version of Istio (1.5 or greater) with telemetry v2:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/iter8_metrics_extended_telemetry-v2.yaml
</code></pre></div><h4 id=note>Note:</h4><blockquote><p>For additional information about how to add a new metric to the existing configuration please see <a href=metrics.md>this documentation</a>.</p></blockquote><p>To verify that the new metric has been added to the configmap, you can check it again:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get configmap iter8config-metrics -n iter8 -oyaml
</code></pre></div><p>We will now configure an experiment to use this new metric for a canary release.</p><h3 id=1-canary-rollout-configuration-2>1. Canary rollout configuration</h3><p>Now, let us set up a canary rollout for <em>reviews-v6</em>, using the following <code>Experiment</code> configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: iter8.tools/v1alpha1
<span style=color:#66d9ef>kind</span>: Experiment
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: reviews-v6-rollout
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>targetService</span>:
    <span style=color:#66d9ef>name</span>: reviews
    <span style=color:#66d9ef>apiVersion</span>: v1
    <span style=color:#66d9ef>baseline</span>: reviews-v3
    <span style=color:#66d9ef>candidate</span>: reviews-v6
  <span style=color:#66d9ef>trafficControl</span>:
    <span style=color:#66d9ef>strategy</span>: check_and_increment
    <span style=color:#66d9ef>interval</span>: 30s
    <span style=color:#66d9ef>trafficStepSize</span>: <span style=color:#ae81ff>20</span>
    <span style=color:#66d9ef>maxIterations</span>: <span style=color:#ae81ff>6</span>
    <span style=color:#66d9ef>maxTrafficPercentage</span>: <span style=color:#ae81ff>80</span>
  <span style=color:#66d9ef>analysis</span>:
    <span style=color:#66d9ef>analyticsService</span>: <span style=color:#e6db74>&#34;http://iter8-analytics:8080&#34;</span>
    <span style=color:#66d9ef>successCriteria</span>:
      - <span style=color:#66d9ef>metricName</span>: iter8_90_perc_latency
        <span style=color:#66d9ef>toleranceType</span>: threshold
        <span style=color:#66d9ef>tolerance</span>: <span style=color:#ae81ff>200</span>
        <span style=color:#66d9ef>sampleSize</span>: <span style=color:#ae81ff>5</span>
</code></pre></div><p>The configuration uses the newly extended metric <em>iter8_90_perc_latency</em>. The success criteria asserts that the canary version (<em>reviews-v6</em>) must have the 90th percentile latency below 200 milliseconds.</p><p>To create the above <code>Experiment</code> object, run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/canary_reviews-v3_to_reviews-v6.yaml
</code></pre></div><p>As usual, iter8 is waiting for the candidate version to be deployed:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   <span style=color:#ae81ff>0</span>            reviews-v3   <span style=color:#ae81ff>100</span>
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v4   <span style=color:#ae81ff>0</span>
reviews-v5-rollout   Completed   ExperimentFailed: Aborted                            reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v5   <span style=color:#ae81ff>0</span>
reviews-v6-rollout   Pause       TargetsNotFound: Missing Candidate                   reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v6   <span style=color:#ae81ff>0</span>
</code></pre></div><h3 id=2-deploy-_reviews-v6_-and-start-the-rollout>2. Deploy <em>reviews-v6</em> and start the rollout</h3><p>As soon as we deploy the candidate version, <em>iter8-controller</em> will start the rollout. This time, the candidate version (<em>reviews-v6</em>) is similar to the earlier <em>reviews-v3</em> which behaved normally. As a result, <em>iter8</em> will roll forward to the candidate version based on the success criterion on the newly extended metric defined above.</p><p>To deploy <em>reviews-v6</em>, run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/reviews-v6.yaml
</code></pre></div><p>If you check the state of the <code>Experiment</code> object corresponding to this rollout, you should see that the rollout is in progress, and that 20% of the traffic is now being sent to <em>reviews-v6</em>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE         STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed     ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   <span style=color:#ae81ff>0</span>            reviews-v3   <span style=color:#ae81ff>100</span>
reviews-v4-rollout   Completed     ExperimentFailed: Not All Success Criteria Met       reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v4   <span style=color:#ae81ff>0</span>
reviews-v5-rollout   Completed     ExperimentFailed: Aborted                            reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v5   <span style=color:#ae81ff>0</span>
reviews-v6-rollout   Progressing   IterationUpdate: Iteration <span style=color:#ae81ff>1</span> Started                 reviews-v3   <span style=color:#ae81ff>80</span>           reviews-v6   <span style=color:#ae81ff>20</span>

</code></pre></div><p>At about every 30s you should see the traffic shift towards <em>reviews-v6</em> by 20 percentage points.</p><p>At the end of the experiment, you will see that all traffic has been shifted to the canary version (<em>reviews-v6</em>)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiments -n bookinfo-iter8
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   <span style=color:#ae81ff>0</span>            reviews-v3   <span style=color:#ae81ff>100</span>
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v4   <span style=color:#ae81ff>0</span>
reviews-v5-rollout   Completed   ExperimentFailed: Aborted                            reviews-v3   <span style=color:#ae81ff>100</span>          reviews-v5   <span style=color:#ae81ff>0</span>
reviews-v6-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v3   <span style=color:#ae81ff>0</span>            reviews-v6   <span style=color:#ae81ff>100</span>
</code></pre></div><h3 id=3-check-the-grafana-dashboard-2>3. Check the Grafana dashboard</h3><p>As before, you can check the Grafana dashboard corresponding to the canary release of <em>reviews-v6</em>. To get the URL to the dashboard specific to this canary release, run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get experiment reviews-v6-rollout -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.status.grafanaURL}&#39;</span> -n bookinfo-iter8
</code></pre></div><p><img src=/images/grafana_reviews-v3-v6-req-rate.png alt="Grafana Dashboard"></p><p><img src=/images/grafana_reviews-v3-v6-error-rate.png alt="Grafana Dashboard"></p><p>You can also extend the Grafana Dashboard with the new metric by adding a new panel to the dashboard that looks as follows:</p><p>Other configurations such as title, legend, etc can be varied as per the user&rsquo;s preference.</p><p><img src=/images/grafana_reviews-v3-v6-90_perc.png alt="Grafana Dashboard"></p><h2 id=part-5-user-facing-canary-release-_productpage-v1_-to-_productpage-v2_>Part 5: User-facing Canary release: <em>productpage-v1</em> to <em>productpage-v2</em></h2><h3 id=1-traffic-configuration>1. Traffic configuration</h3><p>Consider the case now you want to rollout a new version of productpage deployment <em>productpage-v2</em> and expose the service outside of the cluster to users through the host <code>productpage.deployment.com</code>. You will need to setup an Istio <code>Gateway</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#66d9ef>kind</span>: Gateway
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: productpage-gateway
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>istio</span>: ingressgateway <span style=color:#75715e># use istio default controller</span>
  <span style=color:#66d9ef>servers</span>:
  - <span style=color:#66d9ef>port</span>:
      <span style=color:#66d9ef>number</span>: <span style=color:#ae81ff>80</span>
      <span style=color:#66d9ef>name</span>: http
      <span style=color:#66d9ef>protocol</span>: HTTP
    <span style=color:#66d9ef>hosts</span>:
    - <span style=color:#e6db74>&#34;productpage.deployment.com&#34;</span>
</code></pre></div><p>You can run the following command to create the <code>Gateway</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/productpage-gateway.yaml
</code></pre></div><p>Then emulate traffic flowing from outside of the cluster:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>watch -x -n 0.1 curl -Is -H <span style=color:#e6db74>&#39;Host: productpage.deployment.com&#39;</span> <span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>${</span>GATEWAY_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/productpage&#34;</span>
</code></pre></div><h3 id=2-canary-rollout-configuration>2. Canary rollout configuration</h3><p>As specified in the <code>targetService</code> section of the following <code>Experiment</code> configuration, we have kubernetes service <code>productpage</code> directing traffic to deployments <code>productpge-v1</code> and <code>productpage-v2</code>. The entry in <code>hosts</code> tells the controller that traffic will come through <code>"productpage.deployment.com"</code> configured in gateway(istio) <code>paroductpage-gateway</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: iter8.tools/v1alpha1
<span style=color:#66d9ef>kind</span>: Experiment
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: productpage-v2-rollout
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>targetService</span>:
    <span style=color:#66d9ef>name</span>: productpage
    <span style=color:#66d9ef>baseline</span>: productpage-v1
    <span style=color:#66d9ef>candidate</span>: productpage-v2
    <span style=color:#66d9ef>port</span>: <span style=color:#ae81ff>9080</span>
    <span style=color:#66d9ef>hosts</span>:
    - <span style=color:#66d9ef>name</span>: <span style=color:#e6db74>&#34;productpage.deployment.com&#34;</span>
      <span style=color:#66d9ef>gateway</span>: paroductpage-gateway
  <span style=color:#66d9ef>trafficControl</span>:
    <span style=color:#66d9ef>strategy</span>: check_and_increment
    <span style=color:#66d9ef>interval</span>: 30s
    <span style=color:#66d9ef>trafficStepSize</span>: <span style=color:#ae81ff>20</span>
    <span style=color:#66d9ef>maxIterations</span>: <span style=color:#ae81ff>6</span>
    <span style=color:#66d9ef>maxTrafficPercentage</span>: <span style=color:#ae81ff>80</span>
  <span style=color:#66d9ef>analysis</span>:
    <span style=color:#66d9ef>analyticsService</span>: <span style=color:#e6db74>&#34;http://iter8-analytics:8080&#34;</span>
    <span style=color:#66d9ef>successCriteria</span>:
      - <span style=color:#66d9ef>metricName</span>: iter8_latency
        <span style=color:#66d9ef>toleranceType</span>: threshold
        <span style=color:#66d9ef>tolerance</span>: <span style=color:#ae81ff>3.0</span>
        <span style=color:#66d9ef>sampleSize</span>: <span style=color:#ae81ff>5</span>
</code></pre></div><p>To create this <code>Experiment</code> object, run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/canary_productpage-v1_to_productpage-v2.yaml
</code></pre></div><h3 id=3-deploy-_productpage-v2_-and-start-the-rollout>3. Deploy <em>productpage-v2</em> and start the rollout</h3><p>To deploy the candidate version, <em>productpage-v2</em>, run the command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/productpage-v2.yaml
</code></pre></div><p>Now check the state of the <code>Experiment</code> object. You should see that the rollout is in progress, and that a portion of the traffic is being sent to <em>productpage-v2</em>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get experiment productpage-v2-rollout -n bookinfo-iter8
NAME                     PHASE         STATUS                                 BASELINE         PERCENTAGE   CANDIDATE        PERCENTAGE
productpage-v2-rollout   Progressing   IterationUpdate: Iteration <span style=color:#ae81ff>1</span> Started   productpage-v1   <span style=color:#ae81ff>80</span>           productpage-v2   <span style=color:#ae81ff>20</span>
</code></pre></div><h2 id=cleanup>Cleanup</h2><p>You can cleanup by deleting the namespace:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete ns bookinfo-iter8
</code></pre></div><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/hugo-iter8-docs/archive/v0.2.1/js/clipboard.min.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/perfect-scrollbar.min.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/perfect-scrollbar.jquery.min.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/jquery.sticky.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/featherlight.min.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/highlight.pack.js?1596187881></script><script>hljs.initHighlightingOnLoad();</script><script src=/hugo-iter8-docs/archive/v0.2.1/js/modernizr.custom-3.6.0.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/learn.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/hugo-learn.js?1596187881></script><link href=/hugo-iter8-docs/archive/v0.2.1/mermaid/mermaid.css?1596187881 rel=stylesheet><script src=/hugo-iter8-docs/archive/v0.2.1/mermaid/mermaid.js?1596187881></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>