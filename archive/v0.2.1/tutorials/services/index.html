<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.74.3"><meta name=description content="Robust analytics and control to unleash cloud-native continuous experimentation."><meta name=author content="Alan Cha"><link rel=icon href=/hugo-iter8-docs/archive/v0.2.1/images/favicon.png type=image/png><title>Automated Canary Rollout Using Services :: iter8 Documentation</title><link href=/hugo-iter8-docs/archive/v0.2.1/css/nucleus.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/fontawesome-all.min.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/hybrid.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/featherlight.min.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/perfect-scrollbar.min.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/auto-complete.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/atom-one-dark-reasonable.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/theme.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/hugo-theme.css?1596187881 rel=stylesheet><link href=/hugo-iter8-docs/archive/v0.2.1/css/theme-mine.css?1596187881 rel=stylesheet><script src=/hugo-iter8-docs/archive/v0.2.1/js/jquery-3.3.1.min.js?1596187881></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style></head><body data-url=/hugo-iter8-docs/archive/v0.2.1/tutorials/services/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=https://iter8.tools/archive/v0.2.1><img src=/hugo-iter8-docs/archive/v0.2.1/images/logo.png></a></div><a href=/hugo-iter8-docs/archive/v0.2.1/releases/>v0.2.1</a><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/hugo-iter8-docs/archive/v0.2.1/js/lunr.min.js?1596187881></script><script type=text/javascript src=/hugo-iter8-docs/archive/v0.2.1/js/auto-complete.js?1596187881></script><script type=text/javascript>var baseurl="https:\/\/alan-cha.github.io\/hugo-iter8-docs\/archive\/v0.2.1";</script><script type=text/javascript src=/hugo-iter8-docs/archive/v0.2.1/js/search.js?1596187881></script></div><div class=highlightable><ul class=topics><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/introduction/ title=Introduction class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/introduction/>Introduction</a><ul><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/introduction/about/ title="Iter8 enables statistically robust continuous experimentation of microservices in your CI/CD pipelines" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/introduction/about/>About</a></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/ title=Installation class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/>Installation</a><ul><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/kubernetes/ title="Iter8 on Kubernetes and Istio" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/kubernetes/>Kubernetes</a></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/red-hat/ title="Iter8 on Red Hat OpenShift" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/introduction/installation/red-hat/>Red Hat OpenShift</a></li></ul></li></ul></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/reference/ title=Reference class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/reference/>Reference</a><ul><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/reference/metrics/ title="Iter8's metrics" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/reference/metrics/>Metrics</a></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/reference/experiment/ title="Iter8's experiment CRD" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/reference/experiment/>Experiment</a></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/reference/algorithms/ title="Iter8's algorithms" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/reference/algorithms/>Algorithms</a></li></ul></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/tutorials/ title=Tutorials class="dd-item
parent"><a href=/hugo-iter8-docs/archive/v0.2.1/tutorials/>Tutorials</a><ul><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/tutorials/deployments/ title="Automated canary releases with iter8 on Kubernetes and Istio" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/tutorials/deployments/>Deployments</a></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/tutorials/services/ title="Automated Canary Rollout Using Services" class="dd-item active"><a href=/hugo-iter8-docs/archive/v0.2.1/tutorials/services/>Services</a></li></ul></li><li data-nav-id=/hugo-iter8-docs/archive/v0.2.1/releases/ title="Older releases" class=dd-item><a href=/hugo-iter8-docs/archive/v0.2.1/releases/>Older releases</a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/iter8-tools/iter8><i class="fab fa-fw fa-github"></i>GitHub repo</a></li><li><a class=padding href=https://join.slack.com/t/iter8-tools/shared_invite/enQtODU0NTczMTQ5NDU4LTJmNGE1OTBhOWI4NzllZGE0ZjdhM2M3MzJlMjcxYjliMTJlM2YxMzQ4OWQ5NGViYTM2MTU4MWRkZTgxNzZiMzg><i class="fab fa-fw fa-slack"></i>Slack workspace</a></li></ul></section><section id=footer></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/iter8-tools/docs/edit/master/content/tutorials/services.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/hugo-iter8-docs/archive/v0.2.1/>Homepage</a> > <a href=/hugo-iter8-docs/archive/v0.2.1/tutorials/>Tutorials</a> > Automated Canary Rollout Using Services</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#step-1-deploy-the-bookinfo-application>Step 1: Deploy the bookinfo Application</a></li><li><a href=#step-2-configure-traffic-to-the-application>Step 2: Configure Traffic to the Application</a></li><li><a href=#step-3-create-an-iter8-canary-experiment>Step 3: Create an iter8 Canary Experiment</a></li><li><a href=#step-4-generate-load>Step 4: Generate load</a></li><li><a href=#step-5-deploy-the-candidate-version-_productpage-v2_>Step 5: Deploy the candidate version <em>productpage-v2</em></a></li><li><a href=#cleanup>Cleanup</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Automated Canary Rollout Using Services</h1><p>In iter8 the versions of a service being compared can be specified using deployment names or using service names. Other <a href=iter8_bookinfo_istio.md>tutorials</a> showed how to specify different versions using Kubernetes deployment names. In this tutorial, we learn how to do a canary rollout of an application when different versions are indicated by different Kubernetes service names.</p><p>In this tutorial, we again consider the user facing service <em>productpage</em> of the bookinfo application and we learn how to create an iter8 <code>Experiment</code> that specifies the baseline and candidate versions using Kubernetes services. The scenario we consider is here:</p><p><img src=/images/service_deployment.png alt="Example Application Deployment Using Services"></p><p>In this example, the application <em>productpage.example.com</em> can be routed, via an Istio <code>Gateway</code> and <code>VirtualService</code>, to the Kubernetes services. Iter8 can be used to automate the rollout including the creation of the Istio <code>VirtualService</code>.</p><h2 id=step-1-deploy-the-bookinfo-application>Step 1: Deploy the bookinfo Application</h2><p>Create a new namespace: $NAMESPACE. We use the name <code>bookinfo-serivce</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>export NAMESPACE<span style=color:#f92672>=</span>bookinfo-service
kubectl create ns $NAMESPACE
kubectl label ns $NAMESPACE istio-injection<span style=color:#f92672>=</span>enabled
</code></pre></div><p>Deploy the bookinfo application to a new namespace. In particular, we create the service <em>productpage-v1</em> to access the <em>productpage</em> application.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n $NAMESPACE apply -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/bookinfo-tutorial.yaml -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/service/productpage-v1.yaml
</code></pre></div><h2 id=step-2-configure-traffic-to-the-application>Step 2: Configure Traffic to the Application</h2><p>Create an Istio gateway for the external host <code>productpage.example.com</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n $NAMESPACE apply -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/service/bookinfo-gateway.yaml
</code></pre></div><p>At this point, the application is not actually accessible to users because no <code>VirtualService</code> has been defined. Rather than manually define it, this tutorial shows how iter8 can be used to create it for us. To do so, define an iter8 canary experiment from the current version of the application to itself. Clearly, this will succeed, and, as a side effect, a <code>VirtualService</code> will be created.</p><p>In the experiment, the <code>targetService</code> will look like:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>targetService</span>:
    <span style=color:#66d9ef>kind</span>: Service
    <span style=color:#66d9ef>baseline</span>: productpage-v1
    <span style=color:#66d9ef>candidate</span>: productpage-v1
    <span style=color:#66d9ef>hosts</span>:
      - <span style=color:#66d9ef>name</span>: productpage.example.com
        <span style=color:#66d9ef>gateway</span>: productpage-service
</code></pre></div><p>It identifies the type of the baseline and candidate as services using <code>kind: Service</code>. The baseline and candidate names are the same. Further, it identifies the external host name and the Istio <code>Gateway</code> already configured.</p><p>To optimize the bootstrapping process, we can eliminate all of the <code>successCriteria</code>. This has the further benefit of eliminating the need for user traffic. We can also alter the <code>trafficControl</code> options to reduce the time and number of iterations required.</p><p>You can apply an optimized <code>Experiment</code> using:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n $NAMESPACE apply -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/service/bootstrap-productpage.yaml
</code></pre></div><p>You can verify that the <code>Experiment</code> has been created and finishes quickly:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n $NAMESPACE get experiment productpage-bootstrap
NAME                     PHASE       STATUS                                              BASELINE         PERCENTAGE   CANDIDATE        PERCENTAGE
productpage-bootstrap    Completed   ExperimentSucceeded: Last Iteration Was Completed   productpage-v1   <span style=color:#ae81ff>0</span>          productpage-v1   <span style=color:#ae81ff>100</span>
</code></pre></div><p>You can also verify that a virtual service has been created:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n $NAMESPACE get virtualservice
NAME                                       GATEWAYS                HOSTS                       AGE
productpage.example.com.iter8-experiment   <span style=color:#f92672>[</span>productpage-service<span style=color:#f92672>]</span>   <span style=color:#f92672>[</span>productpage.example.com<span style=color:#f92672>]</span>   20m
</code></pre></div><p>This approach may seem unintuitive. However, we illustrate it here because this bootstrapping issue often arises when automating the use of canary rollouts.</p><h2 id=step-3-create-an-iter8-canary-experiment>Step 3: Create an iter8 Canary Experiment</h2><p>We can now create a canary <code>Experiment</code> from version <code>productpage-v1</code> to <code>productpage-v2</code>. The following command will create the <code>Experiment</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n $NAMESPACE apply -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/service/canary_productpage-v1_to_productpage-v2.yaml
</code></pre></div><p>You can verify that the <code>Experiment</code> has been created:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n $NAMESPACE get experiment productpage-v2-rollout
NAME                     PHASE   STATUS                               BASELINE         PERCENTAGE   CANDIDATE        PERCENTAGE
productpage-v2-rollout   Pause   TargetsNotFound: Missing Candidate   productpage-v1   <span style=color:#ae81ff>100</span>   productpage-v2   <span style=color:#ae81ff>0</span>
</code></pre></div><p>The experiment is paused since only the baseline version can be identified. When the candidate version is detected, the experiment will automatically begin execution.</p><h2 id=step-4-generate-load>Step 4: Generate load</h2><p>As in earlier tutorials, emulate requests coming from users using <code>curl</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>watch -x -n 0.1 curl -Is -H <span style=color:#e6db74>&#39;Host: productpage.example.com&#39;</span> <span style=color:#e6db74>&#34;http://</span><span style=color:#e6db74>${</span>GATEWAY_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/productpage&#34;</span>
</code></pre></div><h2 id=step-5-deploy-the-candidate-version-_productpage-v2_>Step 5: Deploy the candidate version <em>productpage-v2</em></h2><p>To start the rollout of the new version of the productpage application, deploy the new version:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n $NAMESPACE apply -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/productpage-v2.yaml -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/service/productpage-v2.yaml
</code></pre></div><p>You can verify the experiment has started:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n $NAMESPACE get experiment productpage-v2-rollout
NAME                     PHASE         STATUS                                 BASELINE         PERCENTAGE   CANDIDATE        PERCENTAGE
productpage-v2-rollout   Progressing   IterationUpdate: Iteration <span style=color:#ae81ff>1</span> Started   productpage-v1   <span style=color:#ae81ff>80</span>           productpage-v2   <span style=color:#ae81ff>20</span>
</code></pre></div><p>You can also verify that the <code>VirtualService</code> created by the bootstrap step has been reused:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n $NAMESPACE get virtualservice
NAME                                       GATEWAYS                HOSTS                       AGE
productpage.example.com.iter8-experiment   <span style=color:#f92672>[</span>productpage-service<span style=color:#f92672>]</span>   <span style=color:#f92672>[</span>productpage.example.com<span style=color:#f92672>]</span>   20m
</code></pre></div><p>As the canary rollout progresses, you should see traffic shift from the baseline to the candidate version until all of the traffic is being sent to the new version.</p><h2 id=cleanup>Cleanup</h2><p>You can cleanup by deleting the namespace:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete ns $NAMESPACE
</code></pre></div><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/hugo-iter8-docs/archive/v0.2.1/js/clipboard.min.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/perfect-scrollbar.min.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/perfect-scrollbar.jquery.min.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/jquery.sticky.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/featherlight.min.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/highlight.pack.js?1596187881></script><script>hljs.initHighlightingOnLoad();</script><script src=/hugo-iter8-docs/archive/v0.2.1/js/modernizr.custom-3.6.0.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/learn.js?1596187881></script><script src=/hugo-iter8-docs/archive/v0.2.1/js/hugo-learn.js?1596187881></script><link href=/hugo-iter8-docs/archive/v0.2.1/mermaid/mermaid.css?1596187881 rel=stylesheet><script src=/hugo-iter8-docs/archive/v0.2.1/mermaid/mermaid.js?1596187881></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>