<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Title -->
  <title>iter8 Documentation</title>

  <!-- Required Meta Tags Always Come First -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Favicon -->
  <link rel="shortcut icon" href="../../../favicon.png">

  <!--  Meta tags -->
  <meta name="keywords"
    content="documentation template, help desk, open source, free template, freebies, bootstrap 4, bootstrap4">
  <meta name="description"
    content="Docs UI Kit is beautiful Open Source Bootstrap 4 UI Kit under MIT license. The UI Kit comes with 10 beautiful complete and functional pages including lots of reusable and customizable UI Blocks. Every component crafted with love to speed up your workflow.">

  <!-- Schema.org -->
  <meta itemprop="name" content="Deliver Better Software with Iter8">
  <meta itemprop="description" content="Iter8 supports cloud-native, automated canary releases and A/B testing of microservices on Kubernetes. Under the hood, iter8 uses robust statistical algorithms to determine the best version of your service, progressively shift traffic towards this version, and eventually rollout this version, where the notion of best is determined by the criteria you specify in your iter8 experiment.">
  <meta itemprop="image" content="assets/img-temp/iter8-promo-resized-open-graph.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="product">
  <meta name="twitter:site" content="@Iter8_app">
  <meta name="twitter:title" content="Deliver Better Software with Iter8">
  <meta name="twitter:description" content="Iter8 supports cloud-native, automated canary releases and A/B testing of microservices on Kubernetes. Under the hood, iter8 uses robust statistical algorithms to determine the best version of your service, progressively shift traffic towards this version, and eventually rollout this version, where the notion of best is determined by the criteria you specify in your iter8 experiment.">
  <meta name="twitter:creator" content="@Iter8_app">
  <meta name="twitter:image" content="assets/img-temp/iter8-promo-resized-open-graph.png">

  <!-- Open Graph -->
  <meta property="og:title" content="Deliver Better Software with Iter8">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://iter8.tools/">
  <meta property="og:image" content="assets/img-temp/iter8-promo-resized-open-graph.png">
  <meta property="og:description" content="Iter8 supports cloud-native, automated canary releases and A/B testing of microservices on Kubernetes. Under the hood, iter8 uses robust statistical algorithms to determine the best version of your service, progressively shift traffic towards this version, and eventually rollout this version, where the notion of best is determined by the criteria you specify in your iter8 experiment.">
  <meta property="og:site_name" content="Htmlstream">

  <!-- Google Fonts -->
  <link href="//fonts.googleapis.com/css?family=Poppins:300,400,500,600" rel="stylesheet">

  <!-- CSS Implementing Plugins -->
  <link rel="stylesheet" href="../../vendor/font-awesome/css/fontawesome-all.min.css">
  <link rel="stylesheet" href="../../vendor/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.css">
  <link rel="stylesheet" href="../../vendor/jquery-ui/themes/base/jquery-ui.min.css">
  <link rel="stylesheet" href="../../vendor/prism/prism.css">

  <!-- CSS Template -->
  <link rel="stylesheet" href="../../css/theme.css">
  <link rel="stylesheet" href="../../css/layout.css">
  <link rel="stylesheet" href="../../css/demo.css">
</head>

<body class="bg-white">
  <!-- Header -->
  <header class="duik-header">
    <nav class="navbar navbar-expand-md fixed-top bg-white border-bottom text-dark py-2">
      <a class="link-dark mr-lg-7 mr-0 mr-md-5" href="../../../index.html.html" target="_self">
        <a class="navbar-brand" href="../../../index.html"><img src="../../img/logo-dark-cropped.png" alt="Iter8"
            style="width: 150px;"></a>
        <span class="ml-3">
          <a href="../more/releases.html"><span class="badge badge-pill badge-dark px-2">v0.2.1</span></a>
        </span>
      </a>
    </nav>
  </header>
  <!-- End Header -->

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 duik-sidebar border-md-right navbar-expand-md">
        <div class="d-flex justify-content-between mb-3">
          <!-- Sidebar Search -->
          <form class="col form-inline input-group-sm pt-2">
            <input class="js-search form-control form-control-sm w-100" type="text" placeholder="Search..."
              data-url="assets/include/json/autocomplete-data-for-documentation-search.json">
          </form>
          <!-- End Sidebar Search -->

          <!-- Responsive Toggle Button -->
          <button class="btn btn-link pl-0 d-md-none" type="button" data-toggle="collapse" data-target="#sidebar-nav"
            aria-controls="sidebar-nav" aria-expanded="false" aria-label="Toggle navigation">
            <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 30 30" width="30" height="30" focusable="false">
              <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10"
                d="M4 7h22M4 15h22M4 23h22" />
            </svg>
          </button>
          <!-- End Responsive Toggle Button -->
        </div>

        <!-- Sidebar Nav -->
        <div class="collapse navbar-collapse border-bottom border-md-0" id="sidebar-nav">
          <div class="js-scrollbar duik-sidebar-sticky">
            <h5 class="duik-sidebar__heading">Introduction</h5>
            <ul class="duik-sidebar__nav">
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../introduction/about.html">About</a>
              </li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link"
                  href="../introduction/install.html">Installation</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link"
                  href="../introduction/experiment.html">Experiment</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link"
                  href="../introduction/metrics.html">Metrics</a></li>
            </ul>

            <h5 class="duik-sidebar__heading">Tutorials</h5>
            <ul class="duik-sidebar__nav">
              <li class="duik-sidebar__item"><a class="duik-sidebar__link active"
                  href="../tutorials/tutorial-automated.html">Automated canary releases</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link"
                  href="../tutorials/tutorial-automated-services.html">Automated canary rollouts</a></li>
            </ul>

            <h5 class="duik-sidebar__heading">Integrations</h5>
            <ul class="duik-sidebar__nav">
              <li class="duik-sidebar__item"><a class="duik-sidebar__link"
                  href="../integrations/grafana.html">Grafana</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../integrations/kiali.html">Kiali</a>
              </li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link"
                  href="../integrations/iter8-trend.html">iter8-trend</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link"
                  href="../integrations/iter8-kui.html">iter8-KUI</a></li>
            </ul>

            <h5 class="duik-sidebar__heading">More</h5>
            <ul class="duik-sidebar__nav">
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../more/algorithm.html">Algorithms</a>
              </li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../more/blogs.html">Blogs</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../more/releases.html">Releases</a></li>
            </ul>
          </div>
        </div>
        <!-- End Sidebar Nav -->
      </nav>
      <!-- End Sidebar -->

      <main class="ml-sm-auto col-md-9 col-lg-10 px-4 pr-10 pt-0 pt-md-11">
        <!-- Content -->
        <div class="col-xl-12 order-xl-1 duik-content border-bottom">

          <!-- Automated tutorial -->
          <div id="tutorial-automated" class="mb-7">
            <h2>Automated canary releases with iter8 on Kubernetes and Istio<a class="js-anchor-link duik-anchorjs-link"
                href="#tutorial-automated" aria-label="Anchor" data-anchorjs-icon="#"></a></h2>

            <!-- Introduction -->
            <div id="introduction" class="mb-7">
              <p>
                This tutorial shows you how iter8 can be used to perform canary releases by gradually shifting traffic
                to a canary version of a microservice.
              </p>

              <p>This tutorial has five parts, with each part building on the
                previous one. <strong>You will learn:</strong></p>

              <ul>
                <li>How to perform a canary rollout with iter8</li>
                <li>How to set different success criteria for iter8 to analyze canary releases and determine success or
                  failure</li>
                <li>How to have iter8 immediately stop an experiment as soon as a criterion is not met
                </li>
                <li>How to use your own custom metrics in success criteria for canary analyses
                </li>
                <li>How iter8 can be used for canary releases of both internal and user-facing services</li>
              </ul>

              <p>The tutorial is based on the <a href="https://istio.io/docs/examples/bookinfo/">Bookinfo sample
                  application</a> that is distributed with Istio. This application
                comprises four microservices, namely, <code>productpage</code>, <code>details</code>,
                <code>reviews</code>, and <code>ratings</code>, as illustrated <a
                  href="https://istio.io/docs/examples/bookinfo/">here</a>.</p>

              <p>Please, follow our instructions below to deploy the sample application as part of the tutorial.</p>

              <h5>YAML files used in the tutorial</h5>

              <p>All Kubernetes YAML files you will need in this tutorial are in the <code>iter8-controller</code>
                repository <a
                  href="https://github.com/iter8-tools/iter8-controller/tree/master/doc/tutorials/istio/bookinfo">here</a>.
              </p>
            </div>
            <!-- End introduction -->

            <!-- Tutorial -->
            <div id="tutorials-5-parts" class="mb-7">
              <nav>
                <ul class="nav nav-tabs" id="nav-tab" role="tablist">
                  <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="nav-part1-tab" data-toggle="tab" href="#nav-part1" role="tab" aria-controls="nav-part1" aria-selected="true">Part 1</a>
                  </li>
                  <li class="nav-item" role="presentation">
                    <a class="nav-link" id="nav-part2-tab" data-toggle="tab" href="#nav-part2" role="tab" aria-controls="nav-part2" aria-selected="false">Part 2</a>
                  </li>
                  <li class="nav-item" role="presentation">
                    <a class="nav-link" id="nav-part3-tab" data-toggle="tab" href="#nav-part3" role="tab" aria-controls="nav-part3" aria-selected="false">Part 3</a>
                  </li>
                  <li class="nav-item" role="presentation">
                    <a class="nav-link" id="nav-part4-tab" data-toggle="tab" href="#nav-part4" role="tab" aria-controls="nav-part4" aria-selected="false">Part 4</a>
                  </li>
                  <li class="nav-item" role="presentation">
                    <a class="nav-link" id="nav-part5-tab" data-toggle="tab" href="#nav-part5" role="tab" aria-controls="nav-part5" aria-selected="false">Part 5</a>
                  </li>
                </ul>
              </nav>

              <br>

              <div class="tab-content" id="nav-tabContent">
                <!-- Part 1 -->
                <div class="tab-pane fade show active" id="nav-part1" role="tabpanel" aria-labelledby="nav-part1-tab">
                  <h5>Successful canary release: <code>reviews-v2</code> to <code>reviews-v3</code><a class="js-anchor-link duik-anchorjs-link"
                      href="#nav-part1" aria-label="Anchor" data-anchorjs-icon="#"></a></h5>

                  <!-- Step 1 -->
                  <div id="nav-part1-step1" class="mb-7">
                    <h6>Step 1: Deploy the Bookinfo application<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part1-step1" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>
                    <p>
                      At this point, we assume that you have already followed the <a
                        href="../introduction/install.html">instructions</a> to install iter8 on your
                      Kubernetes cluster. The next step is to deploy the sample application we will use for the
                      tutorial.
                    </p>

                    <p>
                      First, let us create a <code>bookinfo-iter8</code> namespace configured to enable auto-injection
                      of the Istio sidecar:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/namespace.yaml                      </code>
                    </pre>

                    <p>Next, let us deploy the Bookinfo application:</p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/bookinfo-tutorial.yaml                      </code>
                    </pre>

                    <p>
                      You should see the following pods in the <code>bookinfo-iter8</code> namespace. Make sure the
                      pods' status is
                      "Running." Also, note that there should be two containers in each pod, since the Istio sidecar was
                      injected.
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get pods -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                              READY   STATUS    RESTARTS   AGE
details-v1-68c7c8666d-m78qx       2/2     Running   0          64s
productpage-v1-7979869ff9-fln6g   2/2     Running   0          63s
ratings-v1-8558d4458d-rwthl       2/2     Running   0          64s
reviews-v2-df64b6df9-ffb42        2/2     Running   0          63s</pre>

                    <p>
                      We have deployed "version 2" of the <code>reviews</code> microservice, and version 1 of all
                      others.
                    </p>

                    <p>
                      Let us now expose the edge <code>productpage</code> service by creating an Istio Gateway for it.
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/bookinfo-gateway.yaml                      </code>
                    </pre>

                    <p>
                      You should now see the Istio Gateway and VirtualService for <code>productpage</code>, as below:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get gateway -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME               AGE
bookinfo-gateway   22s</pre>

                    <pre>
                      <code class="language-shell">
                        kubectl get vs -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME       GATEWAYS             HOSTS                   AGE
bookinfo   [bookinfo-gateway]   [bookinfo.sample.dev]   27s</pre>

                    <p>
                      As you can see above, we have associated Bookinfo's edge service with a fake host, namely,
                      <code>bookinfo.sample.dev</code>.
                    </p>
                  </div>
                  <!-- End step 1 -->

                  <!-- Step 2 -->
                  <div id="nav-part1-step2" class="mb-7">
                    <h6>Step 2: Access the Bookinfo application<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part1-step2" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      To access the application, you need to determine the ingress IP and port for the application in
                      your environment. You can do so by following steps 3 and 4 of the Istio instructions <a href="https://istio.io/latest/docs/examples/bookinfo/#determine-the-ingress-ip-and-port">here</a> to set
                      the environment variables <code>INGRESS_HOST</code>, <code>INGRESS_PORT</code>, and
                      <code>GATEWAY_URL</code>, which will capture the correct IP
                      address and port for your environment. Once you have done so, you can check if you can access the
                      application with the following command:
                    </p>

                    <pre>
                    <code class="language-shell">
                      curl -H "Host: bookinfo.sample.dev" -o /dev/null -s -w "%{http_code}\n" "http://${GATEWAY_URL}/productpage"
                    </code>
                  </pre>

                    <p>
                      If everything is working, the command above should show <code>200</code>. Note that the curl
                      command above sets the host header to match the host we associated the VirtualService with
                      (<code>bookinfo.sample.dev</code>). If
                      you want to access the application from your browser, you will need to set this header using a
                      browser's plugin of your choice.
                    </p>
                  </div>
                  <!-- End step 2 -->

                  <!-- Step 3 -->
                  <div id="nav-part1-step3" class="mb-7">
                    <h6>Step 3: Generate load to the application<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part1-step3" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      Let us now generate load to the application, emulating requests coming from users. To do so, we
                      recommend you run the command below on a separate terminal:
                    </p>

                    <pre>
                      <code class="language-shell">
                        watch -n 0.1 'curl -H "Host: bookinfo.sample.dev" -Is "http://${GATEWAY_URL}/productpage"'
                      </code>
                    </pre>

                    <p>
                      This command will send 10 requests per second to the application. Note that the environment
                      variable <code>GATEWAY_URL</code> must have been set as per <a href="#nav-part1-step2">step 2</a> above. Among other things, the command output should show an HTTP code of 200, as below:
                    </p>

                    <pre class="language-shell">
HTTP/1.1 200 OK
content-type: text/html; charset=utf-8
content-length: 5719
server: istio-envoy
(...)</pre>
                  </div>
                  <!-- End step 3 -->

                  <!-- Step 4 -->
                  <div id="nav-part1-step4" class="mb-7">
                    <h6>Step 4: Configure a canary rollout for the reviews service<a
                        class="js-anchor-link duik-anchorjs-link" href="#nav-part1-step4" aria-label="Anchor"
                        data-anchorjs-icon="#"></a></h6>

                    <p>
                      At this point, Bookinfo is using version 2 of the <code>reviews</code> service
                      (<code>reviews-v2</code>). Let us now use iter8
                      to automate the canary rollout of version 3 of this service (<code>reviews-v3</code>).
                    </p>

                    <p>
                      First, we need to tell iter8 that we are about to perform this canary rollout. To that end, we
                      create an <code>Experiment</code> configuration specifying the rollout details. In this tutorial,
                      let us use the following <code>Experiment</code> configuration:
                    </p>

                    <pre class="language-yaml">
apiVersion: iter8.tools/v1alpha1
kind: Experiment
metadata:
  name: reviews-v3-rollout
spec:
  targetService:
    name: reviews
    apiVersion: v1
    baseline: reviews-v2
    candidate: reviews-v3
  trafficControl:
    strategy: check_and_increment
    interval: 30s
    trafficStepSize: 20
    maxIterations: 8
    maxTrafficPercentage: 80
  analysis:
    analyticsService: "http://iter8-analytics:8080"
    successCriteria:
      - metricName: iter8_latency
        toleranceType: threshold
        tolerance: 200
        sampleSize: 5</pre>

                    <p>
                      The configuration above specifies the baseline and candidate versions in terms of Kubernetes
                      deployment names. The rollout is configured to last for eight iterations
                      (<code>maxIterations</code>) of <code>30s</code> (<code>interval</code>). At the end of each
                      iteration, if the candidate version meets the specified success criteria, the traffic sent to it
                      will increase by 20 percentage points (<code>trafficStepSize</code>) up to 80%
                      (<code>maxTrafficPercentage</code>). At the end of the last iteration, if the success criteria are
                      met, the candidate version will take over from the baseline.
                    </p>

                    <p>
                      In the example above, we specified only one success criterion. In particular, we stated that the mean
                      latency exhibited by the candidate version should not exceed the threshold of 200 milliseconds. At
                      the end of each iteration, <code>iter8-controller</code> calls <code>iter8-analytics</code>, which
                      in turn analyzes the metrics of interest (in this case, only mean latency) against the
                      corresponding criteria. The number of data points analyzed during an experiment is cumulative,
                      that is, it carries over from iteration to iteration.
                    </p>

                    <p>
                      The next step of this tutorial is to actually create the configuration above. To that end, you
                      can either copy and paste the YAML above to a file and then run
                      <code>kubectl apply -n bookinfo-iter8 -f</code> on it, or you can run the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/canary_reviews-v2_to_reviews-v3.yaml
                      </code>
                    </pre>

                    <p>You can verify that the <code>Experiment</code> object has been created as shown below:</p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE   STATUS                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Pause   TargetsNotFound: Missing Candidate   reviews-v2   100          reviews-v3</pre>

                    <p>
                      As you can see, iter8 is reporting that 100% of the traffic is sent to the baseline version
                      (<code>reviews-v2</code>) and that the candidate (<code>reviews-v3</code>) is missing. As soon as
                      the controller sees the
                      candidate version, it will start the rollout. Next, let us deploy the candidate version to trigger
                      the canary rollout.
                    </p>
                  </div>
                  <!-- End step 4 -->

                  <!-- Step 5 -->
                  <div id="nav-part1-step5" class="mb-7">
                    <h6>Step 5: Deploy the canary version and start the rollout<a
                        class="js-anchor-link duik-anchorjs-link" href="#nav-part1-step5" aria-label="Anchor"
                        data-anchorjs-icon="#"></a></h6>

                    <p>
                      As soon as we deploy <code>reviews-v3</code>, iter8-controller will start the rollout. To deploy
                      <code>reviews-v3</code>, you can run the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/reviews-v3.yaml
                      </code>
                    </pre>

                    <p>
                      Now, if you check the state of the <code>Experiment</code> object corresponding to this rollout,
                      you should see
                      that the rollout is in progress, and that 20% of the traffic is now being sent to
                      <code>reviews-v3</code>:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE         STATUS                                 BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Progressing   IterationUpdate: Iteration 1 Started   reviews-v2   80           reviews-v3   20</pre>

                    <p>At about every 30s you should see the traffic shift towards <code>reviews-v3</code> by 20
                      percentage points.</p>
                  </div>
                  <!-- End step 5 -->

                  <!-- Step 6 -->
                  <div id="nav-part1-step6" class="mb-7">
                    <h6>Step 6: Check the Grafana dashboard<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part1-step6" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      You can also check a Grafana dashboard specific to the <code>Experiment</code> object corresponding to the rollout you are
                      running. The URL to the Grafana dashboard for the experiment is the value of the field <code>grafanaURL</code>
                      under the object's <code>status</code>. One way to get the Grafana URL that you can paste to your browser is
                      through the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiment reviews-v3-rollout -o jsonpath='{.status.grafanaURL}' -n bookinfo-iter8
                      </code>
                    </pre>

                    <p>
                      By default, the base URL given by iter8 to Grafana is <a
                        href="http://localhost:3000">http://localhost:3000</a>. In a typical Istio
                      installation, you can port-forward your Grafana from Kubernetes to your localhost's port 3000 with
                      the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=grafana -o jsonpath='{.items[0].metadata.name}') 3000:3000
                      </code>
                    </pre>

                    <p>
                      Below is a screenshot of a portion of the Grafana dashboard showing the request rate and the mean
                      latency for <code>reviews-v2</code> and <code>reviews-v3</code>, right after the controller ended
                      the experiment.
                    </p>

                    <img class="d-block w-100 rounded" src="../../img/grafana_reviews-v2-v3.png"
                      alt="Grafana reviews v2 to v3">

                    <br>

                    <p>
                      Note how the traffic shifted towards the canary during the experiment.
                      You can also see that the canary's mean latency was way below the configured threshold of 200 milliseconds.
                    </p>
                  </div>
                  <!-- End step 6 -->

                  <a href="#nav-part2"><button type="button" class="btn btn-primary mb-2 mr-2">Next step</button></a>
                </div>
                <!-- End part 1 -->

                <!-- Part 2 -->
                <div class="tab-pane fade" id="nav-part2" role="tabpanel" aria-labelledby="nav-part2-tab">
                  <h5>High-latency canary release: <code>reviews-v3</code> to <code>reviews-v4</code><a class="js-anchor-link duik-anchorjs-link"
                      href="#nav-part2" aria-label="Anchor" data-anchorjs-icon="#"></a></h5>

                  <!-- Introduction -->
                  <div id="nav-part2-intro" class="mb-7">
                    <p>
                      At this point, you must have completed the <a href="#nav-part1">part 1</a> of the tutorial successfully. You can confirm it as follows:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiment reviews-v3-rollout -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE         STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed     ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   0            reviews-v3   100</pre>

                    <p>
                      The command above's output shows that <code>reviews-v3</code> took over from <code>reviews-v2</code> as part of the canary
                      rollout performed before.
                    </p>
                  </div>
                  <!-- End introduction -->

                  <!-- Step 1 -->
                  <div id="nav-part2-step1" class="mb-7">
                    <h6>Step 1: Canary rollout configuration<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part2-step1" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      Now, let us set up a canary rollout for <code>reviews-v4</code>, using the following <code>Experiment</code>
                      configuration:
                    </p>

                    <pre class="language-yaml">
apiVersion: iter8.tools/v1alpha1
kind: Experiment
metadata:
  name: reviews-v4-rollout
spec:
  targetService:
    name: reviews
    apiVersion: v1
    baseline: reviews-v3
    candidate: reviews-v4
  trafficControl:
    strategy: check_and_increment
    interval: 30s
    trafficStepSize: 20
    maxIterations: 6
    maxTrafficPercentage: 80
  analysis:
    analyticsService: "http://iter8-analytics:8080"
    successCriteria:
      - metricName: iter8_latency
        toleranceType: threshold
        tolerance: 200
        sampleSize: 5</pre>

                    <p>
                      The configuration above is pretty much the same we used in <a href="#nav-part1">part 1</a>, except that now the baseline
                      version is <code>reviews-v3</code> and the candidate is <code>reviews-v4</code>.
                    </p>

                    <p>To create the above <code>Experiment</code> object, run the following command:</p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/canary_reviews-v3_to_reviews-v4.yaml
                      </code>
                    </pre>

                    <p>Or, if using a newer version of Istio (1.5 or greater) with telemetry v2:</p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/0.2.1/doc/tutorials/istio/bookinfo/canary_reviews-v3_to_reviews-v4_telemetry-v2.yaml
                      </code>
                    </pre>

                    <p>You can list all <code>Experiment</code> objects like so:</p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   0            reviews-v3   100
reviews-v4-rollout   Pause       TargetsNotFound: Missing Candidate                   reviews-v3   100          reviews-v4   0</pre>

                    <p>
                      The output above shows the new object you just created, for which the candidate deployment
                      <code>reviews-v4</code> is missing. Let us deploy <code>reviews-v4</code> next so that the rollout can begin.
                    </p>
                  </div>
                  <!-- End step 1 -->

                  <!-- Step 2 -->
                  <div id="nav-part2-step2" class="mb-7">
                    <h6>Step 2: Deploy <code>reviews-v4</code> and start the rollout<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part2-step2" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      As you have already seen, as soon as we deploy the candidate version, iter8-controller will start
                      the rollout. This time, however, the candidate version (<code>reviews-v4</code>) has a performance issue
                      preventing it from satisfying the success criteria in the <code>Experiment</code> object. As a
                      result, iter8 will roll back to the baseline version.
                    </p>

                    <p>To deploy <code>reviews-v4</code>, run the following command:</p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/reviews-v4.yaml
                      </code>
                    </pre>

                    <p>
                      Now, if you check the state of the <code>Experiment</code> object corresponding to this rollout,
                      you should see
                      that the rollout is in progress, and that 20% of the traffic is now being sent to <code>reviews-v4</code>.
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE         STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed     ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   0            reviews-v3   100
reviews-v4-rollout   Progressing   IterationUpdate: Iteration 1 Started                 reviews-v3   80           reviews-v4   20</pre>

                    <p>
                      However, unlike the previous rollout, traffic will not shift towards the candidate <code>reviews-v4</code>
                      because it does not meet the success criteria due to a performance problem. At the end of the
                      experiment, iter8 rolls back to the baseline (<code>reviews-v3</code>), as seen below:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiment reviews-v4-rollout -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   100          reviews-v4   0</pre>
                  </div>
                  <!-- End step 2 -->

                  <!-- Step 3 -->
                  <div id="nav-part2-step3" class="mb-7">
                    <h6>Step 3: Check the Grafana dashboard<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part2-step3" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      As before, you can check the Grafana dashboard corresponding to the canary release of <code>reviews-v4</code>.
                      To get the URL to the dashboard specific to this canary release, run the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiment reviews-v4-rollout -o jsonpath='{.status.grafanaURL}' -n bookinfo-iter8
                      </code>
                    </pre>

                    <img class="d-block w-100 rounded" src="../../img/grafana_reviews-v3-v4.png"
                      alt="Grafana reviews v3 to v4">

                    <br>

                    <p>
                      The dashboard screenshot above shows that the canary version (<code>reviews-v4</code>) consistently exhibits a high latency of 5 seconds, way above the threshold of 200 milliseconds specified in our success criterion, and way above the baseline version's latency.
                    </p>
                  </div>
                  <!-- End step 3 -->

                  <a href="#nav-part1"><button type="button" class="btn btn-primary mb-2 mr-2">Previous step</button></a>
                  <a href="#nav-part3"><button type="button" class="btn btn-primary mb-2 mr-2">Next step</button></a>
                </div>
                <!-- End part 2 -->

                <!-- Part 3 -->
                <div class="tab-pane fade" id="nav-part3" role="tabpanel" aria-labelledby="nav-part3-tab">
                  <h5>Error-producing canary release: <code>reviews-v3</code> to <code>reviews-v5</code><a
                      class="js-anchor-link duik-anchorjs-link" href="#nav-part3" aria-label="Anchor"
                      data-anchorjs-icon="#"></a></h5>

                  <!-- Introduction -->
                  <div id="nav-part3-intro" class="mb-7">
                    <p>
                      At this point, you must have completed parts <a href="#nav-part1">1</a> and <a href="#nav-part2">2</a> of the tutorial successfully. You can confirm
                      it as follows:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   0            reviews-v3   100
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   100          reviews-v4   0</pre>

                    <p>
                      The command above's output shows that <code>reviews-v3</code> took over from <code>reviews-v2</code> as part of the canary
                      rollout performed before on <a href="#nav-part1">part 1</a>, and that it continues to be the current version after iter8
                      had determined that <code>reviews-v4</code> was unsatisfactory.
                    </p>
                  </div>
                  <!-- End introduction -->

                  <!-- Step 1 -->
                  <div id="nav-part3-step1" class="mb-7">
                    <h6>Step 1: Canary rollout configuration<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part3-step1" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      Now, let us set up a canary rollout for <code>reviews-v5</code>, using the following <code>Experiment</code>
                      configuration:
                    </p>

                    <pre class="language-yaml">
apiVersion: iter8.tools/v1alpha1
kind: Experiment
metadata:
  name: reviews-v5-rollout
spec:
  targetService:
    name: reviews
    apiVersion: v1
    baseline: reviews-v3
    candidate: reviews-v5
  trafficControl:
    strategy: check_and_increment
    interval: 30s
    trafficStepSize: 20
    maxIterations: 6
    maxTrafficPercentage: 80
  analysis:
    analyticsService: "http://iter8-analytics:8080"
    successCriteria:
      - metricName: iter8_latency
        toleranceType: threshold
        tolerance: 200
        sampleSize: 5
      - metricName: iter8_error_rate
        toleranceType: delta
        tolerance: 0.02
        sampleSize: 10
        stopOnFailure: true</pre>

                    <p>
                      The configuration above differs from the previous ones as follows. We added a second success
                      criterion on the error-rate metric so that the canary version (<code>reviews-v5</code>) not only must have a
                      mean latency below 200 milliseconds, but it also needs to have an error rate that cannot exceed the
                      baseline error rate by more than 2%. That comparative analysis on a metric is specified as a
                      <code>delta</code> tolerance type. Furthermore, the second success criterion sets the flag
                      <code>stopOnFailure</code>, which means iter8
                      will roll back to the baseline as soon as the error rate criterion is violated and the minimum
                      number of 10 data points is collected (<code>sampleSize = 10</code>).
                    </p>

                    <p>To create the above <code>Experiment</code> object, run the following command:</p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/canary_reviews-v3_to_reviews-v5.yaml
                      </code>
                    </pre>
                  </div>
                  <!-- End step 1 -->

                  <!-- Step 2 -->
                  <div id="nav-part3-step2" class="mb-7">
                    <h6>Step 2: Deploy <code>reviews-v5</code> and start the rollout<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part3-step2" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      As you already know, as soon as we deploy the candidate version, iter8-controller will start the
                      rollout. This time, the candidate version (<code>reviews-v5</code>) has a bug that causes it to return HTTP
                      errors to its callers. As a result, iter8 will roll back to the baseline version based on the
                      success criterion on the error-rate metric defined above.
                    </p>

                    <p>
                      To deploy <code>reviews-v5</code>, run the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/reviews-v5.yaml
                      </code>
                    </pre>

                    <p>
                      If you check the state of the <code>Experiment</code> object corresponding to this rollout, you
                      should see that
                      the rollout is in progress, and that 20% of the traffic is now being sent to <code>reviews-v5</code>.
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE         STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed     ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   0            reviews-v3   100
reviews-v4-rollout   Completed     ExperimentFailed: Not All Success Criteria Met       reviews-v3   100          reviews-v4   0
reviews-v5-rollout   Progressing   IterationUpdate: Iteration 1 Started                 reviews-v3   80           reviews-v5   20</pre>

                    <p>
                      Because review-v5 has an issue causing it to return HTTP errors, as per the success criteria we
                      have specified the traffic will not shift towards it. Furthermore, because the error-rate success
                      criteria indicated the need to stop on failure, without waiting for the entire duration of the
                      experiment, iter8 will rollback to <code>reviews-v3</code> quickly. You should see the following after several
                      seconds:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   0            reviews-v3   100
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   100          reviews-v4   0
reviews-v5-rollout   Completed   ExperimentFailed: Aborted                            reviews-v3   100          reviews-v5   0</pre>
                  </div>
                  <!-- End step 2 -->

                  <!-- Step 3 -->
                  <div id="nav-part3-step3" class="mb-7">
                    <h6>Step 3: Check the Grafana dashboard<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part3-step3" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      As before, you can check the Grafana dashboard corresponding to the canary release of <code>reviews-v5</code>.
                      To get the URL to the dashboard specific to this canary release, run the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiment reviews-v5-rollout -o jsonpath='{.status.grafanaURL}' -n bookinfo-iter8
                      </code>
                    </pre>

                    <img class="d-block w-100 rounded" src="../../img/grafana_reviews-v3-v5-req-rate.png"
                      alt="Grafana reviews v3 to v5 request rate">

                    <img class="d-block w-100 rounded" src="../../img/grafana_reviews-v3-v5-error-rate.png"
                      alt="Grafana reviews v3 to v5 error rate">

                    <br>

                    <p>
                      The dashboard screenshots above show that traffic to the canary version (<code>reviews-v5</code>) is quickly
                      interrupted. Also, while the <code>reviews-v5</code> latency is way below the threshold of 200 milliseconds we defined in the latency success criterion, its error rate is 100%, i.e., it generates errors for every single request it processes. That does not meet the error-rate success criterion we defined, which
                      specified that the canary's error rate must be within 2% of that of the baseline (<code>reviews-v3</code>)
                      version. According to the dashboard, <code>reviews-v3</code> produced no errors at all.
                    </p>
                  </div>
                  <!-- End step 3 -->

                  <a href="#nav-part2"><button type="button" class="btn btn-primary mb-2 mr-2">Previous step</button></a>
                  <a href="#nav-part4"><button type="button" class="btn btn-primary mb-2 mr-2">Next step</button></a>
                </div>
                <!-- End part 3 -->

                <!-- Part 4 -->
                <div class="tab-pane fade" id="nav-part4" role="tabpanel" aria-labelledby="nav-part4-tab">
                  <h5>Using a custom metric<a class="js-anchor-link duik-anchorjs-link" href="#nav-part4"
                      aria-label="Anchor" data-anchorjs-icon="#"></a></h5>

                  <!-- Introduction -->
                  <div id="nav-part4-intro" class="mb-7">
                    <p>
                      At this point, you should have completed parts <a href="#nav-part1">1</a>,
                      <a href="#nav-part2">2</a>, and <a href="#nav-part3">3</a>
                      of the tutorial successfully. You can confirm it as follows:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   0            reviews-v3   100
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   100          reviews-v4   0
reviews-v5-rollout   Completed   ExperimentFailed: Aborted                            reviews-v3   100          reviews-v5   0</pre>

                    <p>
                      The command above's output shows that <code>reviews-v3</code> took over from <code>reviews-v2</code> as part of the canary
                      rollout performed before in <a href="#nav-part1">part 1</a>, and that it continued to be the current version of the reviews service after iter8 had determined that <code>reviews-v4</code> was unsatisfactory. Similarly, as we saw in the
                      previous <a href="#nav-part3">part 3</a>, the experiment to rollout <code>reviews-v5</code> was aborted because of failure to satisfy
                      the success criteria defined by the user.
                    </p>

                    <p>
                      In this tutorial, we will define a custom metric (one not provided by iter8 out of the box) and
                      use it in the success criteria for a canary release.
                    </p>

                    <p>
                      By default iter8 provides a few metrics which you can see if you type:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get configmap iter8config-metrics -n iter8 -oyaml
                      </code>
                    </pre>

                    <p>
                      In principle, any metric that can be derived from the data you have in your Prometheus database
                      that might be meaningful to you in assessing the health of a service version can be used by iter8.
                      Next, we are going to make iter8 aware of a metric that we will call
                      <code>iter8_90_perc_latency</code>, which
                      measures the 90th percentile latency of a service. In order to make iter8 aware of a new metric we
                      need to add it to the <code>iter8config-metrics</code> config map. For the purposes of this
                      tutorial, we will do
                      so by running the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/iter8_metrics_extended.yaml
                      </code>
                    </pre>

                    <p>Or, if using a newer version of Istio (1.5 or greater) with telemetry v2:</p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/iter8_metrics_extended_telemetry-v2.yaml
                      </code>
                    </pre>

                    <!-- Notes -->
                    <div id="nav-part4-intro-notes" class="mb-7">
                      <h6>Note<a class="js-anchor-link duik-anchorjs-link" href="#nav-part4-intro-notes"
                          aria-label="Anchor" data-anchorjs-icon="#"></a></h6>
                      <p>
                        For additional information about how to add a new metric to the existing configuration please
                        see this documentation.
                      </p>

                      <p>
                        To verify that the new metric has been added to the <code>ConfigMap</code>, you can check it
                        again:
                      </p>

                      <pre>
                        <code class="language-shell">
                          kubectl get configmap iter8config-metrics -n iter8 -oyaml
                        </code>
                      </pre>

                      <p>We will now configure an experiment to use this new metric for a canary release.</p>
                    </div>
                    <!-- End notes -->
                  </div>
                  <!-- End introduction -->

                  <!-- Step 1 -->
                  <div id="nav-part4-step1" class="mb-7">
                    <h6>Step 1: Canary rollout configuration<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part4-step1" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      Now, let us set up a canary rollout for <code>reviews-v6</code>, using the following <code>Experiment</code>
                      configuration:
                    </p>

                    <pre class="language-yaml">
apiVersion: iter8.tools/v1alpha1
kind: Experiment
metadata:
  name: reviews-v6-rollout
spec:
  targetService:
    name: reviews
    apiVersion: v1
    baseline: reviews-v3
    candidate: reviews-v6
  trafficControl:
    strategy: check_and_increment
    interval: 30s
    trafficStepSize: 20
    maxIterations: 6
    maxTrafficPercentage: 80
  analysis:
    analyticsService: "http://iter8-analytics:8080"
    successCriteria:
      - metricName: iter8_90_perc_latency
        toleranceType: threshold
        tolerance: 200
        sampleSize: 5</pre>

                    <p>
                      The configuration uses the newly extended metric <code>iter8_90_perc_latency</code>. The success
                      criteria asserts
                      that the canary version (<code>reviews-v6</code>) must have the 90th percentile latency below 200 milliseconds.
                    </p>

                    <p>
                      To create the above <code>Experiment</code> object, run the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/canary_reviews-v3_to_reviews-v6.yaml
                      </code>
                    </pre>

                    <p>As usual, iter8 is waiting for the candidate version to be deployed:</p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   0            reviews-v3   100
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   100          reviews-v4   0
reviews-v5-rollout   Completed   ExperimentFailed: Aborted                            reviews-v3   100          reviews-v5   0
reviews-v6-rollout   Pause       TargetsNotFound: Missing Candidate                   reviews-v3   100          reviews-v6   0</pre>
                  </div>
                  <!-- End step 1 -->

                  <!-- Step 2 -->
                  <div id="nav-part4-step2" class="mb-7">
                    <h6>Step 2: Deploy <code>reviews-v6</code> and start the rollout<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part4-step2" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      As soon as we deploy the candidate version, iter8-controller will start the rollout. This time,
                      the candidate version (<code>reviews-v6</code>) is similar to the earlier <code>reviews-v3</code> which behaved normally. As a result, iter8 will roll forward to the candidate version based on the success criterion on the
                      newly extended metric defined above.
                    </p>

                    <p>To deploy <code>reviews-v6</code>, run the following command:</p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/reviews-v6.yaml
                      </code>
                    </pre>

                    <p>
                      If you check the state of the <code>Experiment</code> object corresponding to this rollout, you
                      should see that the rollout is in progress, and that 20% of the traffic is now being sent to
                      <code>reviews-v6</code>.
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE         STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed     ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   0            reviews-v3   100
reviews-v4-rollout   Completed     ExperimentFailed: Not All Success Criteria Met       reviews-v3   100          reviews-v4   0
reviews-v5-rollout   Completed     ExperimentFailed: Aborted                            reviews-v3   100          reviews-v5   0
reviews-v6-rollout   Progressing   IterationUpdate: Iteration 1 Started                 reviews-v3   80           reviews-v6   20</pre>

                    <p>
                      At about every 30s you should see the traffic shift towards <code>reviews-v6</code> by 20 percentage points.
                    </p>

                    <p>
                      At the end of the experiment, you will see that all traffic has been shifted to the canary
                      version (<code>reviews-v6</code>)
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiments -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-shell">
NAME                 PHASE       STATUS                                               BASELINE     PERCENTAGE   CANDIDATE    PERCENTAGE
reviews-v3-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v2   0            reviews-v3   100
reviews-v4-rollout   Completed   ExperimentFailed: Not All Success Criteria Met       reviews-v3   100          reviews-v4   0
reviews-v5-rollout   Completed   ExperimentFailed: Aborted                            reviews-v3   100          reviews-v5   0
reviews-v6-rollout   Completed   ExperimentSucceeded: All Success Criteria Were Met   reviews-v3   0            reviews-v6   100</pre>
                  </div>
                  <!-- End step 2 -->

                  <!-- Step 3 -->
                  <div id="nav-part4-step3" class="mb-7">
                    <h6>Step 3: Check the Grafana dashboard<a class="js-anchor-link duik-anchorjs-link"
                        href="#nav-part4-step3" aria-label="Anchor" data-anchorjs-icon="#"></a></h6>

                    <p>
                      As before, you can check the Grafana dashboard corresponding to the canary release of <code>reviews-v6</code>.
                      To get the URL to the dashboard specific to this canary release, run the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiment reviews-v6-rollout -o jsonpath='{.status.grafanaURL}' -n bookinfo-iter8
                      </code>
                    </pre>

                    <img class="d-block w-100 rounded" src="../../img/grafana_reviews-v3-v6-req-rate.png"
                      alt="Grafana reviews v3 to v6 request rate">

                    <img class="d-block w-100 rounded" src="../../img/grafana_reviews-v3-v6-error-rate.png"
                      alt="Grafana reviews v3 to v6 error rate">

                    <br>

                    <p>
                      You can also extend the Grafana Dashboard with the new metric by adding a new panel to the
                      dashboard that looks as follows:
                    </p>

                    <p>Other configurations such as title, legend, etc. can be varied as per the user's preference.</p>

                    <img class="d-block w-100 rounded" src="../../img/grafana_reviews-v3-v6-90_perc.png"
                      alt="Grafana reviews v3 to v6 90th percentile latency">
                  </div>
                  <!-- End step 3 -->

                  <a href="#nav-part3"><button type="button" class="btn btn-primary mb-2 mr-2">Previous step</button></a>
                  <a href="#nav-part5"><button type="button" class="btn btn-primary mb-2 mr-2">Next step</button></a>
                </div>
                <!-- End part 4 -->

                <!-- Part 5 -->
                <div class="tab-pane fade" id="nav-part5" role="tabpanel" aria-labelledby="nav-part5-tab">
                  <h5>User-facing Canary release: <code>productpage-v1</code> to <code>productpage-v2</code><a
                      class="js-anchor-link duik-anchorjs-link" href="#nav-part5" aria-label="Anchor"
                      data-anchorjs-icon="#"></a></h5>

                  <!-- Step 1 -->
                  <div id="nav-part5-step1" class="mb-7">
                    <h6>Step 1: Traffic configuration<a
                      class="js-anchor-link duik-anchorjs-link" href="#nav-part5-step1" aria-label="Anchor"
                      data-anchorjs-icon="#"></a></h6>
                    <p>
                      Consider the case now you want to rollout a new version of <code>productpage</code> deployment <code>productpage-v2</code>
                      and expose the service outside of the cluster to users through the host
                      <code>productpage.deployment.com</code>. You will need to setup an Istio <code>Gateway</code>:
                    </p>

                    <pre class="language-yaml">
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: productpage-gateway
spec:
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "productpage.deployment.com"</pre>

                    <p>
                      You can run the following command to create the <code>Gateway</code>:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/productpage-gateway.yaml
                      </code>
                    </pre>

                    <p>
                      Then emulate traffic flowing from outside of the cluster:
                    </p>

                    <pre>
                      <code class="language-shell">
                        watch -x -n 0.1 curl -Is -H 'Host: productpage.deployment.com' "http://${GATEWAY_URL}/productpage"
                      </code>
                    </pre>
                  </div>
                  <!-- End step 1 -->

                  <!-- Step 2 -->
                  <div id="nav-part5-step2" class="mb-7">
                    <h6>Step 2: Canary rollout configuration<a
                      class="js-anchor-link duik-anchorjs-link" href="#nav-part5-step2" aria-label="Anchor"
                      data-anchorjs-icon="#"></a></h6>

                    <p>
                      As specified in the <code>targetService</code> section of the following <code>Experiment</code>
                      configuration, we have kubernetes service <code>productpage</code> directing traffic to deployments
                      <code>productpage-v1</code> and
                      <code>productpage-v2</code>. The entry in <code>hosts</code> tells the controller that traffic will come
                      through <code>"productpage.deployment.com"</code> configured in gateway (istio)
                      <code>paroductpage-gateway</code>:
                    </p>

                    <pre class="language-yaml">
apiVersion: iter8.tools/v1alpha1
kind: Experiment
metadata:
  name: productpage-v2-rollout
spec:
  targetService:
    name: productpage
    baseline: productpage-v1
    candidate: productpage-v2
    port: 9080
    hosts:
    - name: "productpage.deployment.com"
      gateway: paroductpage-gateway
  trafficControl:
    strategy: check_and_increment
    interval: 30s
    trafficStepSize: 20
    maxIterations: 6
    maxTrafficPercentage: 80
  analysis:
    analyticsService: "http://iter8-analytics:8080"
    successCriteria:
      - metricName: iter8_latency
        toleranceType: threshold
        tolerance: 3.0
        sampleSize: 5</pre>

                    <p>
                      To create this <code>Experiment</code> object, run the following command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/canary_productpage-v1_to_productpage-v2.yaml
                      </code>
                    </pre>
                  </div>
                  <!-- End step 2 -->

                  <!-- Step 3 -->
                  <div id="nav-part5-step3" class="mb-7">
                    <h6>Step 3: Deploy <code>productpage-v2</code> and start the rollout<a
                      class="js-anchor-link duik-anchorjs-link" href="#nav-part5-step3" aria-label="Anchor"
                      data-anchorjs-icon="#"></a></h6>

                    <p>
                      To deploy the candidate version, <code>productpage-v2</code>, run the command:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl apply -n bookinfo-iter8 -f https://raw.githubusercontent.com/iter8-tools/iter8-controller/v0.2.1/doc/tutorials/istio/bookinfo/productpage-v2.yaml
                      </code>
                    </pre>

                    <p>
                      Now check the state of the <code>Experiment</code> object. You should see that the rollout is in
                      progress, and that a portion of the traffic is being sent to <code>productpage-v2</code>.
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl get experiment productpage-v2-rollout -n bookinfo-iter8
                      </code>
                    </pre>

                    <pre class="language-yaml">
NAME                     PHASE         STATUS                                 BASELINE         PERCENTAGE   CANDIDATE        PERCENTAGE
productpage-v2-rollout   Progressing   IterationUpdate: Iteration 1 Started   productpage-v1   80           productpage-v2   20</pre>
                  </div>
                  <!-- End step 3 -->

                  <!-- Cleanup -->
                  <div id="nav-part5-cleanup" class="mb-7">
                    <h6>Cleanup<a
                      class="js-anchor-link duik-anchorjs-link" href="#nav-part5-cleanup" aria-label="Anchor"
                      data-anchorjs-icon="#"></a></h6>

                    <p>
                      You can cleanup by deleting the namespace:
                    </p>

                    <pre>
                      <code class="language-shell">
                        kubectl delete ns bookinfo-iter8
                      </code>
                    </pre>
                  </div>
                  <!-- End cleanup -->

                  <a href="#nav-part4"><button type="button" class="btn btn-primary mb-2 mr-2">Previous step</button></a>
                </div>
                <!-- End part 5 -->
              </div>
            </div>
            <!-- End tutorial -->
          </div>
          <!-- End automated tutorial -->      </main>
    </div>
  </div>

  <!-- Go to Top -->
  <a class="js-go-to duik-go-to" href="javascript:;">
    <span class="fa fa-arrow-up duik-go-to__inner"></span>
  </a>
  <!-- End Go to Top -->

  <!-- JS Global Compulsory -->
  <script src="../../vendor/jquery/dist/jquery.min.js"></script>
  <script src="../../vendor/jquery-migrate/dist/jquery-migrate.min.js"></script>
  <script src="../../vendor/popper.js/dist/umd/popper.min.js"></script>
  <script src="../../vendor/bootstrap/dist/js/bootstrap.min.js"></script>

  <!-- JS Implementing Plugins -->
  <script src="../../vendor/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="../../vendor/jquery-ui/jquery-ui.core.min.js"></script>
  <script src="../../vendor/jquery-ui/ui/widgets/menu.js"></script>
  <script src="../../vendor/jquery-ui/ui/widgets/mouse.js"></script>
  <script src="../../vendor/jquery-ui/ui/widgets/autocomplete.js"></script>
  <script src="../../vendor/prism/prism.js"></script>

  <!-- JS -->
  <script src="../../js/main.js"></script>
  <script src="../../js/autocomplete.js"></script>
  <script src="../../js/custom-scrollbar.js"></script>
  <script src="../../js/documentation/tutorials/tutorial-automated.js"></script>
</body>

</html>