<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Title -->
  <title>iter8 Documentation - Canary Tutorial with Services</title>

  <!-- Required Meta Tags Always Come First -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Favicon -->
  <link rel="shortcut icon" href="../../../favicon.png">

  <!--  Meta tags -->
  <meta name="keywords" content="Iter8, A/B testing, microservices, Kubernetes, software, cloud, analytics, canary release">
  <meta name="description" content="Iter8 supports cloud-native, automated canary releases and A/B testing of microservices on Kubernetes. Under the hood, iter8 uses robust statistical algorithms to determine the best version of your service, progressively shift traffic towards this version, and eventually rollout this version, where the notion of best is determined by the criteria you specify in your iter8 experiment.">

  <!-- Schema.org -->
  <meta itemprop="name" content="Deliver Better Software with Iter8">
  <meta itemprop="description" content="Iter8 supports cloud-native, automated canary releases and A/B testing of microservices on Kubernetes. Under the hood, iter8 uses robust statistical algorithms to determine the best version of your service, progressively shift traffic towards this version, and eventually rollout this version, where the notion of best is determined by the criteria you specify in your iter8 experiment.">
  <meta itemprop="image" content="https://iter8.tools/docs/assets/img-temp/iter8-promo-resized-open-graph.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="product">
  <meta name="twitter:title" content="Deliver Better Software with Iter8">
  <meta name="twitter:description" content="Iter8 supports cloud-native, automated canary releases and A/B testing of microservices on Kubernetes. Under the hood, iter8 uses robust statistical algorithms to determine the best version of your service, progressively shift traffic towards this version, and eventually rollout this version, where the notion of best is determined by the criteria you specify in your iter8 experiment.">
  <meta name="twitter:image" content="https://iter8.tools/docs/assets/img-temp/iter8-promo-resized-open-graph.png">

  <!-- Open Graph -->
  <meta property="og:title" content="Deliver Better Software with Iter8">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://iter8.tools/">
  <meta property="og:image" content="https://iter8.tools/docs/assets/img-temp/iter8-promo-resized-open-graph.png">
  <meta property="og:description" content="Iter8 supports cloud-native, automated canary releases and A/B testing of microservices on Kubernetes. Under the hood, iter8 uses robust statistical algorithms to determine the best version of your service, progressively shift traffic towards this version, and eventually rollout this version, where the notion of best is determined by the criteria you specify in your iter8 experiment.">
  <meta property="og:site_name" content="iter8 Documentation">

  <!-- Google Fonts -->
  <link href="//fonts.googleapis.com/css?family=Poppins:300,400,500,600" rel="stylesheet">

  <!-- CSS Implementing Plugins -->
  <link rel="stylesheet" href="../../vendor/font-awesome/css/fontawesome-all.min.css">
  <link rel="stylesheet" href="../../vendor/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.css">
  <link rel="stylesheet" href="../../vendor/jquery-ui/themes/base/jquery-ui.min.css">
  <link rel="stylesheet" href="../../vendor/prism/prism.css">

  <!-- CSS Template -->
  <link rel="stylesheet" href="../../css/theme.css">
  <link rel="stylesheet" href="../../css/layout.css">
  <link rel="stylesheet" href="../../css/demo.css">
</head>

<body class="bg-white">
  <!-- Header -->
  <header class="duik-header">
    <nav class="navbar navbar-expand-md fixed-top bg-white border-bottom text-dark py-2">
      <a class="link-dark mr-lg-7 mr-0 mr-md-5" href="../../../index.html.html" target="_self">
        <a class="navbar-brand" href="../../../index.html"><img src="../../img/logo-dark-cropped.png" alt="Iter8"
            style="width: 150px;"></a>
        <span class="ml-3">
          <a href="../more/releases.html"><span class="badge badge-pill badge-dark px-2">v0.2.1</span></a>
        </span>
      </a>
    </nav>
  </header>
  <!-- End Header -->

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 duik-sidebar border-md-right navbar-expand-md">
        <div class="d-flex justify-content-between mb-3">
          <!-- Sidebar Search -->
          <form class="col form-inline input-group-sm pt-2">
            <input class="js-search form-control form-control-sm w-100" type="text" placeholder="Search..."
              data-url="assets/include/json/autocomplete-data-for-documentation-search.json">
          </form>
          <!-- End Sidebar Search -->

          <!-- Responsive Toggle Button -->
          <button class="btn btn-link pl-0 d-md-none" type="button" data-toggle="collapse" data-target="#sidebar-nav"
            aria-controls="sidebar-nav" aria-expanded="false" aria-label="Toggle navigation">
            <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 30 30" width="30" height="30" focusable="false">
              <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10"
                d="M4 7h22M4 15h22M4 23h22" />
            </svg>
          </button>
          <!-- End Responsive Toggle Button -->
        </div>

        <!-- Sidebar Nav -->
        <div class="collapse navbar-collapse border-bottom border-md-0" id="sidebar-nav">
          <div class="js-scrollbar duik-sidebar-sticky">
            <h5 class="duik-sidebar__heading">Introduction</h5>
            <ul class="duik-sidebar__nav">
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../introduction/about.html">About</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../introduction/installation.html">Installation</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../introduction/experiment.html">Experiment</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../introduction/metrics.html">Metrics</a></li>
            </ul>

            <h5 class="duik-sidebar__heading">Tutorials</h5>
            <ul class="duik-sidebar__nav">
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../tutorials/tutorial-deployments.html">Canary with deployments</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link active" href="../tutorials/tutorial-services.html">Canary with services</a></li>
            </ul>

            <h5 class="duik-sidebar__heading">Integrations</h5>
            <ul class="duik-sidebar__nav">
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../integrations/grafana.html">Grafana</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../integrations/kiali.html">Kiali</a></li>
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../integrations/iter8-trend.html">iter8-trend</a></li>
              <!-- <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../integrations/iter8-kui.html">iter8-KUI</a></li> -->
            </ul>

            <h5 class="duik-sidebar__heading">More</h5>
            <ul class="duik-sidebar__nav">
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../more/algorithm.html">Algorithms</a></li>
              <!-- <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../more/blogs.html">Blogs</a></li> -->
              <li class="duik-sidebar__item"><a class="duik-sidebar__link" href="../more/releases.html">Releases</a></li>
            </ul>
          </div>
        </div>
        <!-- End Sidebar Nav -->
      </nav>
      <!-- End Sidebar -->

      <main class="ml-sm-auto col-md-9 col-lg-10 px-4 pr-10 pt-0 pt-md-11">
        <!-- Content -->
        <div class="col-xl-12 order-xl-1 duik-content border-bottom">

          <!-- Automated services tutorial -->
          <div id="tutorial-deployments-services" class="mb-7">
            <h2>Automated canary rollout using services<a class="js-anchor-link duik-anchorjs-link"
                href="#tutorial-deployments-services" aria-label="Anchor"
                data-anchorjs-icon="#"></a></h2>

            <!-- Introducion -->
            <div id="tutorial-deployments-services-intro" class="mb-7">
              <p>
                In iter8 the versions of a service being compared can be specified using deployment names or using service
                names. Other <a href="tutorial-deployments.html">tutorials</a> showed how to specify different versions
                using Kubernetes deployment names. In this tutorial, we learn how to do a canary rollout of an application
                when different versions are indicated by different Kubernetes service names.
              </p>
  
              <p>
                In this tutorial, we again consider the user facing service <code>productpage</code> of the bookinfo
                application and we learn how to create an iter8 <code>Experiment</code> that specifies the baseline and
                candidate versions using Kubernetes services. The scenario we consider is here:
              </p>
  
              <img src="../../img/service_deployment.png" alt="Example Application Deployment Using Services">
  
              <p>In this example, the application <code>productpage.example.com</code> can be routed, via an Istio
                <code>Gateway</code> and <code>VirtualService</code>, to the Kubernetes services. Iter8 can be used to
                automate the rollout including the creation of the Istio <code>VirtualService</code>.</p>  
            </div>
            <!-- End introducion -->
           
            <!-- Step 1 -->
            <div id="tutorial-deployments-services-step1" class="mb-7">
              <h6>Step 1: Deploy the Bookinfo application<a class="js-anchor-link duik-anchorjs-link"
                href="#tutorial-deployments-services-step1" aria-label="Anchor"
                data-anchorjs-icon="#"></a></h6>

              <p>
                Create a new namespace: $NAMESPACE. We use the name <code>bookinfo-service</code>.
              </p>

              <pre>
                <code class="language-shell">
                  export NAMESPACE=bookinfo-service
                  kubectl create ns $NAMESPACE
                  kubectl label ns $NAMESPACE istio-injection=enabled
                </code>
              </pre>

              <p>
                Deploy the bookinfo application to a new namespace. In particular, we create the service
                <code>productpage-v1</code> to access the <code>productpage</code> application.
              </p>

              <pre>
                <code class="language-shell">
                  kubectl -n $NAMESPACE apply -f https://raw.githubusercontent.com/iter8-tools/iter8/v0.2.1/doc/tutorials/istio/bookinfo/bookinfo-tutorial.yaml -f https://raw.githubusercontent.com/iter8-tools/iter8/v0.2.1/doc/tutorials/istio/bookinfo/service/productpage-v1.yaml
                </code>
              </pre>
            </div>
            <!-- End step 1 -->

            <!-- Step 2 -->
            <div id="tutorial-deployments-services-step2" class="mb-7">
              <h6>Step 2: Configure Traffic to the Application<a class="js-anchor-link duik-anchorjs-link"
                href="#tutorial-deployments-services-step2" aria-label="Anchor"
                data-anchorjs-icon="#"></a></h6>

              <p>
                Create an Istio gateway for the external host <code>productpage.example.com</code>:
              </p>

              <pre>
                <code class="language-shell">
                  kubectl -n $NAMESPACE apply -f https://raw.githubusercontent.com/iter8-tools/iter8/v0.2.1/doc/tutorials/istio/bookinfo/service/bookinfo-gateway.yaml
                </code>
              </pre>

              <p>
                At this point, the application is not actually accessible to users because no
                <code>VirtualService</code> has been defined. Rather than manually define it, this tutorial shows how
                iter8 can be used to create it for us. To do so, define an iter8 canary experiment from the current
                version of the application to itself. Clearly, this will succeed, and, as a side effect, a
                <code>VirtualService</code> will be created.
              </p>

              <p>
                In the experiment, the <code>targetService</code> will look like:
              </p>

              <!-- Output -->
              <pre class="language-shell">
targetService:
  kind: Service
  baseline: productpage-v1
  candidate: productpage-v1
  hosts:
    - name: productpage.example.com
      gateway: productpage-service</pre>

              <p>
                It identifies the type of the baseline and candidate as services using <code>kind: Service</code>. The
                baseline and candidate names are the same. Further, it identifies the external host name and the Istio
                <code>Gateway</code> already configured.
              </p>

              <p>
                To optimize the bootstrapping process, we can eliminate all of the <code>successCriteria</code>. This
                has the further benefit of eliminating the need for user traffic. We can also alter the
                <code>trafficControl</code> options to reduce the time and number of iterations required.
              </p>

              <p>
                You can apply an optimized <code>Experiment</code> using:
              </p>

              <pre>
                <code class="language-shell">
                  kubectl -n $NAMESPACE apply -f https://raw.githubusercontent.com/iter8-tools/iter8/v0.2.1/doc/tutorials/istio/bookinfo/service/bootstrap-productpage.yaml
                </code>
              </pre>

              You can verify that the <code>Experiment</code> has been created and finishes quickly:

              <pre>
                <code class="language-shell">
                  kubectl -n $NAMESPACE get experiment productpage-bootstrap
                </code>
              </pre>

              <!-- Output -->
              <pre class="language-shell">
NAME                     PHASE       STATUS                                              BASELINE         PERCENTAGE   CANDIDATE        PERCENTAGE
productpage-bootstrap    Completed   ExperimentSucceeded: Last Iteration Was Completed   productpage-v1   0          productpage-v1   100</pre>

              <p>
                You can also verify that a virtual service has been created:
              </p>

              <pre>
                <code class="language-shell">
                  kubectl -n $NAMESPACE get virtualservice
                </code>
              </pre>

              <!-- Output -->
              <pre class="language-shell">
NAME                                       GATEWAYS                HOSTS                       AGE
productpage.example.com.iter8-experiment   [productpage-service]   [productpage.example.com]   20m</pre>

              <p>
                This approach may seem unintuitive. However, we illustrate it here because this bootstrapping issue
                often arises when automating the use of canary rollouts.
              </p>
            </div>
            <!-- End step 2 -->

            <!-- Step 3 -->
            <div id="tutorial-deployments-services-step3" class="mb-7">
              <h6>Step 3: Create an iter8 Canary Experiment<a class="js-anchor-link duik-anchorjs-link"
                href="#tutorial-deployments-services-step3" aria-label="Anchor"
                data-anchorjs-icon="#"></a></h6>

              <p>We can now create a canary <code>Experiment</code> from version <code>productpage-v1</code> to
                <code>productpage-v2</code>. The following command will create the <code>Experiment</code>:</p>

              <pre>
                <code class="language-shell">
                  kubectl -n $NAMESPACE apply -f https://raw.githubusercontent.com/iter8-tools/iter8/v0.2.1/doc/tutorials/istio/bookinfo/service/canary_productpage-v1_to_productpage-v2.yaml
                </code>
              </pre>

              <p>You can verify that the <code>Experiment</code> has been created:</p>

              <pre>
                <code class="language-shell">
                  kubectl -n $NAMESPACE get experiment productpage-v2-rollout
                </code>
              </pre>

              <!-- Output -->
              <pre class="language-shell">
NAME                     PHASE   STATUS                               BASELINE         PERCENTAGE   CANDIDATE        PERCENTAGE
productpage-v2-rollout   Pause   TargetsNotFound: Missing Candidate   productpage-v1   100   productpage-v2   0</pre>

              <p>The experiment is paused since only the baseline version can be identified. When the candidate version
                is detected, the experiment will automatically begin execution.</p>
            </div>
            <!-- End step 3 -->

            <!-- Step 4 -->
            <div id="tutorial-deployments-services-step4" class="mb-7">
              <h6>Step 4: Generate load<a class="js-anchor-link duik-anchorjs-link"
                href="#tutorial-deployments-services-step4" aria-label="Anchor"
                data-anchorjs-icon="#"></a></h6>

              <p>As in earlier tutorials, emulate requests coming from users using <code>curl</code>:</p>

              <pre>
                <code class="language-shell">
                  watch -x -n 0.1 curl -Is -H 'Host: productpage.example.com' "http://${GATEWAY_URL}/productpage"
                </code>
              </pre>
            </div>
            <!-- End step 4 -->

            <!-- Step 5 -->
            <div id="tutorial-deployments-services-step5" class="mb-7">
              <h6>Step 5: Deploy the candidate version <code>productpage-v2</code><a class="js-anchor-link duik-anchorjs-link"
                href="#tutorial-deployments-services-step5" aria-label="Anchor"
                data-anchorjs-icon="#"></a></h6>

              <p>
                To start the rollout of the new version of the productpage application, deploy the new version:
              </p>

              <pre>
                <code class="language-shell">
                  kubectl -n $NAMESPACE apply -f https://raw.githubusercontent.com/iter8-tools/iter8/v0.2.1/doc/tutorials/istio/bookinfo/productpage-v2.yaml -f https://raw.githubusercontent.com/iter8-tools/iter8/v0.2.1/doc/tutorials/istio/bookinfo/service/productpage-v2.yaml
                </code>
              </pre>

              <p>
                You can verify the experiment has started:
              </p>

              <pre>
                <code class="language-shell">
                  kubectl -n $NAMESPACE get experiment productpage-v2-rollout
                </code>
              </pre>

              <!-- Output -->
              <pre class="language-shell">
  NAME                     PHASE         STATUS                                 BASELINE         PERCENTAGE   CANDIDATE        PERCENTAGE
  productpage-v2-rollout   Progressing   IterationUpdate: Iteration 1 Started   productpage-v1   80           productpage-v2   20</pre>

              <p>
                You can also verify that the <code>VirtualService</code> created by the bootstrap step has been reused:
              </p>

              <pre>
                <code class="language-shell">
                  kubectl -n $NAMESPACE get virtualservice
                </code>
              </pre>

              <!-- Output -->
              <pre class="language-shell">
  NAME                                       GATEWAYS                HOSTS                       AGE
  productpage.example.com.iter8-experiment   [productpage-service]   [productpage.example.com]   20m</pre>

              <p>
                As the canary rollout progresses, you should see traffic shift from the baseline to the candidate
                version until all of the traffic is being sent to the new version.
              </p>
            </div>
            <!-- End step 5 -->

            <!-- Clean up -->
            <div id="tutorial-deployments-services-cleanup" class="mb-7">
              <h6>Cleanup<a class="js-anchor-link duik-anchorjs-link"
                href="#tutorial-deployments-services-cleanup" aria-label="Anchor"
                data-anchorjs-icon="#"></a></h6>

              <p>
                You can cleanup by deleting the namespace:
              </p>

              <pre>
                <code class="language-shell">
                  kubectl delete ns $NAMESPACE
                </code>
              </pre>
            </div>
            <!-- End clean up -->
          </div>
          <!-- End automated services tutorial -->    
        </div>
      </main>
    </div>
  </div>

  <!-- Go to Top -->
  <a class="js-go-to duik-go-to" href="javascript:;">
    <span class="fa fa-arrow-up duik-go-to__inner"></span>
  </a>
  <!-- End Go to Top -->

  <!-- JS Global Compulsory -->
  <script src="../../vendor/jquery/dist/jquery.min.js"></script>
  <script src="../../vendor/jquery-migrate/dist/jquery-migrate.min.js"></script>
  <script src="../../vendor/popper.js/dist/umd/popper.min.js"></script>
  <script src="../../vendor/bootstrap/dist/js/bootstrap.min.js"></script>

  <!-- JS Implementing Plugins -->
  <script src="../../vendor/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="../../vendor/jquery-ui/jquery-ui.core.min.js"></script>
  <script src="../../vendor/jquery-ui/ui/widgets/menu.js"></script>
  <script src="../../vendor/jquery-ui/ui/widgets/mouse.js"></script>
  <script src="../../vendor/jquery-ui/ui/widgets/autocomplete.js"></script>
  <script src="../../vendor/prism/prism.js"></script>

  <!-- JS -->
  <script src="../../js/main.js"></script>
  <script src="../../js/autocomplete.js"></script>
  <script src="../../js/custom-scrollbar.js"></script>
</body>

</html>